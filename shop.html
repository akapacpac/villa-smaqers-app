<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magasin - Villa des SMAQeurs Bris√©s</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDqCYiGvSYitgoPnGdxMzkautcYl511E3I",
            authDomain: "villa-smaqers-brises.firebaseapp.com",
            projectId: "villa-smaqers-brises",
            storageBucket: "villa-smaqers-brises.firebasestorage.app",
            messagingSenderId: "387262093007",
            appId: "1:387262093007:web:76173a1e3cd49d80a249ba",
            measurementId: "G-TBNFR17E82"
        };
        
        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Rendre Firebase disponible globalement
        window.auth = auth;
        window.db = db;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            min-height: 100vh;
            color: #333;
            transition: background 0.3s ease;
        }
        
        body.bachelor-theme {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        body.master-theme {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .nav-tab:hover {
            background: #f8f9fa;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* Limiter les fillings √† 3 par ligne maximum */
        #crepesGrid.product-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        
        @media (max-width: 900px) {
            #crepesGrid.product-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            #crepesGrid.product-grid {
                grid-template-columns: 1fr;
            }
        }

        .product-card {
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 280px;
        }

        .product-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .product-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .product-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .product-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
        }

        .product-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
            min-height: 40px;
            flex: 1;
        }

        .order-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: auto;
        }

        .order-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        #classModal {
            display: none !important;
        }

        #classModal.show {
            display: flex !important;
        }

        .order-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Form styles for class selection modal */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2d3436;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-full {
            width: 100%;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e1e5e9;
        }

        .orders-table th,
        .orders-table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
            font-size: 0.9rem;
        }

        .orders-table th:first-child,
        .orders-table td:first-child {
            width: 50px;
            text-align: center;
            padding: 12px 8px;
        }

        .order-checkbox {
            transform: scale(1.3);
            cursor: pointer;
            accent-color: #007bff;
        }

        #selectAllCheckbox {
            transform: scale(1.3);
            cursor: pointer;
            accent-color: #007bff;
        }

        .orders-table th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-weight: 700;
            color: #495057;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #dee2e6;
        }

        .orders-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .orders-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .orders-table tbody tr:nth-child(even) {
            background-color: #fafbfc;
        }

        .orders-table tbody tr:nth-child(even):hover {
            background-color: #f1f3f4;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 25px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-pending {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 1px solid #ffc107;
        }

        .status-confirmed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #28a745;
        }

        .status-delivered {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 1px solid #17a2b8;
        }

        .status-badge-clickable {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            display: inline-block;
            transition: all 0.2s;
            user-select: none;
        }
        
        .status-badge-clickable:hover {
            opacity: 0.8;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-badge-clickable::after {
            content: ' ‚ñº';
            font-size: 0.6rem;
            opacity: 0.7;
            display: inline-block;
        }
        
        .status-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 150px;
            display: none !important;
            margin-top: 5px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        
        .status-dropdown-menu.show {
            display: block !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        .status-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .status-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .status-dropdown-item:hover {
            background: #f8f9fa;
        }

        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1rem;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                border-bottom: 1px solid #e1e5e9;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <h1 id="shop-title">üè™ Magasin Villa des SMAQeurs</h1>
            <p>Commandez vos snacks pr√©f√©r√©s !</p>
            
            <!-- View Toggle for Admins and Members - En haut du header -->
            <div id="view-toggle-shop" style="display: none; position: absolute; top: 20px; right: 20px; padding: 10px 15px; background: rgba(255,255,255,0.95); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; gap: 10px; align-items: center;">
                <label style="font-weight: bold; color: #333; font-size: 14px; margin-right: 5px;">Vue:</label>
                <button id="view-bachelor-shop" onclick="switchViewShop('bachelor')" style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; background: #667eea; color: white; font-weight: 600; font-size: 14px;">
                    üëÅÔ∏è Bachelor
                </button>
                <button id="view-master-shop" onclick="switchViewShop('master')" style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; background: #6c757d; color: white; font-weight: 600; font-size: 14px;">
                    üëÅÔ∏è Master
                </button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('orders')">
                üìù Commander
            </button>
            <button class="nav-tab" onclick="showTab('my-orders')">
                üìã Mes Commandes
            </button>
            <button class="nav-tab" onclick="showTab('my-account')">
                üë§ Mon Compte
            </button>
            <button class="nav-tab admin-only" onclick="showTab('admin')" style="display: none;">
                üöö Livraison
            </button>
            <button class="nav-tab admin-only" onclick="showTab('restock')" style="display: none;">
                üì¶ Restock
            </button>
            <button class="nav-tab admin-only" onclick="showTab('customization')" style="display: none;">
                ‚öôÔ∏è Personnalisation
            </button>
            <a href="private.html" class="nav-tab admin-only" style="display: none; text-decoration: none; color: inherit;">
                üîí Administration Priv√©e
            </a>
        </div>

        <div class="tab-content">
            <!-- Onglet Commander -->
            <div id="orders" class="tab-pane active">
                <h2 style="margin-bottom: 30px; color: #333;">Choisissez votre commande</h2>
                
                <!-- Section Cr√™pes -->
                <div id="crepesSection" style="margin-bottom: 40px;">
                    <h3 style="margin-bottom: 20px; color: #333; font-size: 1.3rem; border-bottom: 2px solid #667eea; padding-bottom: 10px;">ü•û Cr√™pes</h3>
                    <div id="crepesGrid" class="product-grid">
                        <div class="loading">Chargement des produits...</div>
                    </div>
                    </div>

                <!-- Section Snacks (affich√©e uniquement s'il y a des snacks en stock) -->
                <div id="snacksSection" style="display: none; margin-bottom: 40px; border-top: 2px solid #e1e5e9; padding-top: 40px;">
                    <h3 style="margin-bottom: 20px; color: #333; font-size: 1.3rem; border-bottom: 2px solid #667eea; padding-bottom: 10px;">üç™ Snacks</h3>
                    <div id="snacksGrid" class="product-grid">
                        <div class="loading">Chargement des snacks...</div>
                    </div>
                </div>
                
                <!-- Message quand plus de stock -->
                <div id="noStockMessage" style="display: none; text-align: center; margin-top: 30px; padding: 30px; background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-radius: 15px; border: 2px solid #ffc107; box-shadow: 0 4px 15px rgba(255,193,7,0.2);">
                    <div style="font-size: 3rem; margin-bottom: 15px;">üòî</div>
                    <h3 style="color: #856404; margin-bottom: 10px; font-size: 1.5rem;">D√©sol√©, restez attentif au prochain drop de cr√™pes !</h3>
                    <p style="color: #856404; font-size: 1.1rem; margin: 0;">Le stock est temporairement √©puis√©. Revenez bient√¥t !</p>
                </div>
            </div>

            <!-- Onglet Mes Commandes -->
            <div id="my-orders" class="tab-pane">
                <h2 style="margin-bottom: 30px; color: #333;">Historique de mes commandes</h2>
                <div id="ordersTable">
                    <div class="loading">Chargement de vos commandes...</div>
                </div>
            </div>

            <!-- Onglet Mon Compte -->
            <div id="my-account" class="tab-pane">
                <h2 style="margin-bottom: 30px; color: #333;">Mes informations</h2>
                <div id="userAccount">
                    <div class="loading">Chargement de vos informations...</div>
                </div>
            </div>

            <!-- Onglet Administration -->
            <div id="admin" class="tab-pane">
                <h2 style="margin-bottom: 30px; color: #333;">Livraison - Toutes les commandes</h2>
                
                <!-- Conteneur principal pour filtres et tableau -->
                <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <!-- Filtres -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleFilters()">
                            <h3 style="margin: 0; color: #333; font-size: 1.2rem;">üîç Filtres et Actions</h3>
                            <span id="filterArrow" style="font-size: 1.2rem; transition: transform 0.3s;">‚ñº</span>
                        </div>
                        <div id="filtersContent" style="display: none; margin-top: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Statut :</label>
                                    <select id="statusFilter" style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#e1e5e9'">
                                        <option value="">Tous les statuts</option>
                                        <option value="pending">En attente</option>
                                        <option value="confirmed">Confirm√©e</option>
                                        <option value="delivered">Livr√©e</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Type de produit :</label>
                                <select id="productFilter" style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#e1e5e9'">
                                    <option value="">Tous les produits</option>
                                    <option value="crepes-sucre">Cr√™pes Sucre</option>
                                    <option value="crepes-nutella">Cr√™pes Nutella</option>
                                    <option value="crepes-confiture">Cr√™pes Confiture</option>
                                    <option value="crepes">Cr√™pes (ancien)</option>
                                    <option value="cookie">Cookie</option>
                                    <option value="gaufre">Gaufre</option>
                                </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Salle :</label>
                                    <input type="text" id="classFilter" placeholder="Ex: 650" style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#e1e5e9'">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Tri par :</label>
                                    <select id="sortFilter" style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#e1e5e9'">
                                        <option value="date-desc">Date (plus r√©cent)</option>
                                        <option value="date-asc">Date (plus ancien)</option>
                                        <option value="user">Utilisateur</option>
                                        <option value="product">Produit</option>
                                        <option value="status">Statut</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 20px;">
                                <button onclick="applyFilters()" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(0,123,255,0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    üîç Appliquer les filtres
                                </button>
                                <button onclick="selectAllVisible()" style="background: linear-gradient(135deg, #28a745, #1e7e34); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(40,167,69,0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    ‚úÖ Tout s√©lectionner
                                </button>
                                <button onclick="deselectAll()" style="background: linear-gradient(135deg, #6c757d, #545b62); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(108,117,125,0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    ‚ùå Tout d√©s√©lectionner
                                </button>
                            </div>
                        </div>
                        
                        <!-- Actions en lot -->
                        <div id="bulkActions" style="display: none; background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid #ffc107; box-shadow: 0 2px 10px rgba(255,193,7,0.2);">
                            <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px;">
                                <span id="selectedCount" style="font-weight: 700; color: #856404; font-size: 1.1rem;">0 commande(s) s√©lectionn√©e(s)</span>
                                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                                    <button onclick="markSelectedAsDelivered()" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                        üì¶ Marquer comme livr√©es
                                    </button>
                                    <button onclick="deleteSelected()" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                        üóëÔ∏è Supprimer s√©lectionn√©es
                                    </button>
                                    <button onclick="deleteAllFiltered()" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                        ‚ö†Ô∏è Supprimer tout (filtr√©)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tableau des commandes -->
                    <div id="adminOrdersTable">
                        <div class="loading">Chargement de toutes les commandes...</div>
                    </div>
                </div>
            </div>

            <!-- Onglet Restock -->
            <div id="restock" class="tab-pane">
                <h2 style="margin-bottom: 30px; color: #333;">üì¶ Gestion du Stock</h2>
                
                <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <!-- Information sur le syst√®me de stock -->
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #2196f3;">
                        <h3 style="margin: 0 0 15px 0; color: #1976d2; font-size: 1.2rem;">‚ÑπÔ∏è Syst√®me de Stock Simplifi√©</h3>
                        <div style="font-size: 0.95rem; color: #424242; line-height: 1.5;">
                            <p><strong>Comment √ßa marche :</strong></p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>Vous ajoutez un nombre total de cr√™pes (ex: 20)</li>
                                <li>Optionnellement, vous pouvez limiter certaines cat√©gories</li>
                                <li>Les √©tudiants peuvent commander tant qu'il y a du stock</li>
                                <li>Quand le stock est √©puis√©, plus de commandes possibles</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Statut du stock actuel -->
                    <div id="stockDisplay" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #2196f3;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #1976d2; font-size: 1.3rem;">üìä Stock Actuel <span id="stock-program-indicator" style="font-size: 0.9rem; color: #666;">(Bachelor)</span></h3>
                            <button onclick="resetAllStock()" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                üîÑ Reset Stock
                            </button>
                        </div>
                        <div id="stockContent">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e1e5e9;">
                                    <div style="font-size: 1.5rem; margin-bottom: 5px;">ü•û</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #007bff;" id="stockSucreDisplay">0</div>
                                    <div style="font-size: 0.9rem; color: #666;">Cr√™pes Sucre</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e1e5e9;">
                                    <div style="font-size: 1.5rem; margin-bottom: 5px;">üç´</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #007bff;" id="stockNutellaDisplay">0</div>
                                    <div style="font-size: 0.9rem; color: #666;">Cr√™pes Nutella</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e1e5e9;">
                                    <div style="font-size: 1.5rem; margin-bottom: 5px;">üçì</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #007bff;" id="stockConfitureDisplay">0</div>
                                    <div style="font-size: 0.9rem; color: #666;">Cr√™pes Confiture</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; text-align: center; font-size: 0.9rem; color: #666;">
                                Total global : <strong id="totalStockDisplay">0</strong> cr√™pes
                            </div>
                        </div>
                    </div>

                    <!-- Restock Cr√™pes -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 20px 0; color: #333; font-size: 1.2rem;">ü•û Restock Cr√™pes</h3>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e1e5e9;">
                            <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Nombre de cr√™pes √† ajouter :</label>
                                    <input type="number" id="restockQuantity" min="1" max="1000" placeholder="Ex: 20" 
                                           style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s;" 
                                           onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#e1e5e9'">
                                </div>
                                <button onclick="addStock()" 
                                        style="background: linear-gradient(135deg, #28a745, #1e7e34); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(40,167,69,0.3);" 
                                        onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    ‚ûï Ajouter Cr√™pes
                                </button>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                                üí° Ajoute des cr√™pes au stock g√©n√©ral. Les fillings sont g√©r√©s s√©par√©ment.
                            </div>
                        </div>
                    </div>

                    <!-- Gestion des Fillings -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 20px 0; color: #333; font-size: 1.2rem;">üçØ Gestion des Fillings</h3>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e1e5e9;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <!-- Sucre -->
                                <div style="padding: 15px; border: 1px solid #e1e5e9; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                        <span style="font-size: 1.5rem;">ü•û</span>
                                        <h4 style="margin: 0; color: #333;">Cr√™pes Sucre</h4>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Status actuel :</label>
                                        <div style="font-size: 1.1rem; font-weight: bold; color: #007bff;" id="fillingSucreDisplay">‚àû</div>
                                    </div>
                                    <div style="display: flex; gap: 10px; align-items: end;">
                                        <div style="flex: 1;">
                                            <input type="number" id="fillingSucreQty" min="1" max="1000" placeholder="Quantit√©" 
                                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
                                        </div>
                                        <button onclick="updateFilling('crepes-sucre', 'fillingSucreQty')" 
                                                style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                            Mettre √† jour
                                        </button>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: #666;">
                                            <input type="checkbox" id="unlimitedSucre" onchange="toggleFillingUnlimited('crepes-sucre', 'unlimitedSucre')">
                                            Illimit√©
                                        </label>
                                    </div>
                                </div>

                                <!-- Nutella -->
                                <div style="padding: 15px; border: 1px solid #e1e5e9; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                        <span style="font-size: 1.5rem;">üç´</span>
                                        <h4 style="margin: 0; color: #333;">Cr√™pes Nutella</h4>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Status actuel :</label>
                                        <div style="font-size: 1.1rem; font-weight: bold; color: #007bff;" id="fillingNutellaDisplay">‚àû</div>
                                    </div>
                                    <div style="display: flex; gap: 10px; align-items: end;">
                                        <div style="flex: 1;">
                                            <input type="number" id="fillingNutellaQty" min="1" max="1000" placeholder="Quantit√©" 
                                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
                                        </div>
                                        <button onclick="updateFilling('crepes-nutella', 'fillingNutellaQty')" 
                                                style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                            Mettre √† jour
                                        </button>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: #666;">
                                            <input type="checkbox" id="unlimitedNutella" onchange="toggleFillingUnlimited('crepes-nutella', 'unlimitedNutella')">
                                            Illimit√©
                                        </label>
                                    </div>
                                </div>

                                <!-- Confiture -->
                                <div style="padding: 15px; border: 1px solid #e1e5e9; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                        <span style="font-size: 1.5rem;">üçì</span>
                                        <h4 style="margin: 0; color: #333;">Cr√™pes Confiture</h4>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Status actuel :</label>
                                        <div style="font-size: 1.1rem; font-weight: bold; color: #007bff;" id="fillingConfitureDisplay">‚àû</div>
                                    </div>
                                    <div style="display: flex; gap: 10px; align-items: end;">
                                        <div style="flex: 1;">
                                            <input type="number" id="fillingConfitureQty" min="1" max="1000" placeholder="Quantit√©" 
                                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
                                        </div>
                                        <button onclick="updateFilling('crepes-confiture', 'fillingConfitureQty')" 
                                                style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                            Mettre √† jour
                                        </button>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: #666;">
                                            <input type="checkbox" id="unlimitedConfiture" onchange="toggleFillingUnlimited('crepes-confiture', 'unlimitedConfiture')">
                                            Illimit√©
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                                üí° <strong>Comment √ßa marche :</strong> Illimit√© = toujours disponible. Nombre = quantit√© limit√©e qui diminue √† chaque commande.
                            </div>
                        </div>
                    </div>

                    <!-- Gestion du Stock des Snacks -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 20px 0; color: #333; font-size: 1.2rem;">üç™ Gestion du Stock des Snacks</h3>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e1e5e9;">
                            <p style="color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                                G√©rez le stock de chaque snack. Les snacks n'appara√Ætront dans la page de commande que s'ils ont un stock > 0.
                            </p>
                            
                            <div id="snacksStockManagement" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div class="loading">Chargement des snacks...</div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <button onclick="resetAllSnacksStock()" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                                    üîÑ Reset Tous les Snacks
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Historique des restocks -->
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px;">
                        <h3 style="margin: 0 0 20px 0; color: #333; font-size: 1.2rem;">üìà Historique des Restocks</h3>
                        <div id="restockHistory">
                            <div style="text-align: center; padding: 20px; color: #666;">
                                Chargement de l'historique...
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Personnalisation -->
            <div id="customization" class="tab-pane">
                <h2 style="margin-bottom: 30px; color: #333;">‚öôÔ∏è Personnalisation des Produits</h2>
                
                <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <!-- Section Fillings de Cr√™pes -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="margin-bottom: 20px; color: #333; font-size: 1.5rem; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                            ü•û Fillings de Cr√™pes (Maximum 9)
                        </h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                            G√©rez les fillings disponibles pour les cr√™pes. Vous pouvez ajouter, modifier ou supprimer des fillings (maximum 9).
                        </p>
                        
                        <button onclick="showAddFillingModal()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 20px;">
                            ‚ûï Ajouter un Filling
                        </button>
                        
                        <div id="fillingsList" style="display: grid; gap: 15px;">
                            <div class="loading">Chargement des fillings...</div>
                        </div>
                    </div>
                    
                    <!-- Section Snacks -->
                    <div style="margin-bottom: 40px; border-top: 2px solid #e1e5e9; padding-top: 40px;">
                        <h3 style="margin-bottom: 20px; color: #333; font-size: 1.5rem; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                            üç™ Snacks
                        </h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                            G√©rez les snacks disponibles (eau, coca, cookies, etc.). Ces produits appara√Ætront dans la section commande uniquement s'ils sont en stock.
                        </p>
                        
                        <button onclick="showAddSnackModal()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 20px;">
                            ‚ûï Ajouter un Snack
                        </button>
                        
                        <div id="snacksList" style="display: grid; gap: 15px;">
                            <div class="loading">Chargement des snacks...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour la classe -->
    <div id="classModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; box-shadow: 0 20px 40px rgba(0,0,0,0.3); margin: 20px;">
            <h3 style="margin-bottom: 20px; color: #333; text-align: center;">Confirmer votre commande</h3>
            
            <!-- Selected Product Display -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Article s√©lectionn√©</label>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-weight: bold; color: #6c5ce7;" id="modal-selected-item-display"></div>
                </div>
            
            <!-- Class Selection Section -->
            <div class="form-group">
                <label class="form-label">S√©lectionner ou cr√©er une salle *</label>
                
                <!-- Search/Create Toggle -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button type="button" id="select-class-btn" class="btn" onclick="showClassSelection()" style="flex: 1;">
                        üìö S√©lectionner une salle existante
                    </button>
                    <button type="button" id="create-class-btn" class="btn btn-secondary" onclick="showClassCreation()" style="flex: 1;">
                        ‚ûï Cr√©er une nouvelle salle
                    </button>
            </div>
                
                <!-- Class Selection -->
                <div id="class-selection-section" style="display: block;">
                    <div class="form-group">
                        <label class="form-label">Rechercher une salle</label>
                        <input type="text" id="class-search" class="form-input" placeholder="Rechercher par salle (ex: 104, 156, 345-378)" oninput="filterClasses()">
                    </div>
                    <div id="classes-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                        <p style="text-align: center; color: #666; padding: 20px;">Chargement des salles...</p>
                    </div>
                    <div id="selected-class-info" style="display: none; margin-top: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                        <p><strong>Salle s√©lectionn√©e:</strong> <span id="selected-class-name"></span></p>
                        <p><strong>Horaire:</strong> <span id="selected-class-time"></span></p>
                        <p><strong>Livraison pr√©vue:</strong> <span id="selected-delivery-time"></span></p>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            <strong>Deadline:</strong> <span id="selected-deadline-time"></span>
                        </p>
                    </div>
                </div>
                
                <!-- Class Creation -->
                <div id="class-creation-section" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Num√©ro de salle *</label>
                        <input type="text" id="new-class-room" class="form-input" placeholder="Ex: 104, 156, 345-378" required>
                        <small style="color: #666; font-size: 12px;">Entrez le num√©ro ou nom de la salle</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Heure de d√©but du cours *</label>
                        <input type="time" id="new-class-start" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Heure de fin du cours *</label>
                        <input type="time" id="new-class-end" class="form-input" required>
                    </div>
                    <button type="button" class="btn btn-full" onclick="createNewClass()">Cr√©er la salle</button>
                    <button type="button" class="btn btn-secondary btn-full" onclick="showClassSelection()" style="margin-top: 10px;">Annuler</button>
                </div>
                
                <input type="hidden" id="selected-class-id" value="">
                <input type="hidden" id="selected-class-schedule-id" value="">
            </div>
            
            <!-- Vote Section -->
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Votez pour votre liste *</label>
                <div style="display: flex; gap: 15px; margin-top: 10px;">
                    <button type="button" id="vote-red-btn" class="btn" onclick="selectVote('red')" style="flex: 1; background: #dc3545; color: white; border: 3px solid transparent;">
                        üî¥ Liste Rouge
                    </button>
                    <button type="button" id="vote-green-btn" class="btn" onclick="selectVote('green')" style="flex: 1; background: #28a745; color: white; border: 3px solid transparent;">
                        üü¢ Liste Verte
                    </button>
                </div>
                <input type="hidden" id="selected-vote" value="">
            </div>
            
            <div id="order-deadline-warning" style="display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;">
                <p style="margin: 0; color: #856404;">
                    ‚ö†Ô∏è <strong>Attention:</strong> La deadline de commande est dans <span id="deadline-countdown"></span>
                </p>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button onclick="hideClassModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    Annuler
                </button>
                <button onclick="confirmOrder()" id="modal-confirm-btn" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;" disabled>
                    Confirmer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter/modifier un Filling -->
    <div id="fillingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; box-shadow: 0 20px 40px rgba(0,0,0,0.3); margin: 20px;">
            <h3 id="fillingModalTitle" style="margin-bottom: 20px; color: #333; text-align: center;">Ajouter un Filling</h3>
            <form id="fillingForm" onsubmit="event.preventDefault(); saveFilling();">
                <div class="form-group">
                    <label class="form-label">Nom du filling *</label>
                    <input type="text" id="fillingName" class="form-input" placeholder="Ex: Cr√™pes Sucre" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Emoji *</label>
                    <input type="text" id="fillingEmoji" class="form-input" placeholder="Ex: ü•û" maxlength="2" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="fillingDescription" class="form-input" rows="3" placeholder="Ex: Cr√™pes avec sucre et beurre"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ID Produit * (unique)</label>
                    <input type="text" id="fillingProductId" class="form-input" placeholder="Ex: crepes-sucre" required>
                    <small style="color: #666; font-size: 12px;">Cet ID sera utilis√© pour identifier le produit dans les commandes</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Ordre d'affichage</label>
                    <input type="number" id="fillingOrder" class="form-input" min="1" value="1">
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button type="button" onclick="document.getElementById('fillingModal').style.display = 'none'" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        Annuler
                    </button>
                    <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal pour ajouter/modifier un Snack -->
    <div id="snackModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; box-shadow: 0 20px 40px rgba(0,0,0,0.3); margin: 20px;">
            <h3 id="snackModalTitle" style="margin-bottom: 20px; color: #333; text-align: center;">Ajouter un Snack</h3>
            <form id="snackForm" onsubmit="event.preventDefault(); saveSnack();">
                <div class="form-group">
                    <label class="form-label">Nom du snack *</label>
                    <input type="text" id="snackName" class="form-input" placeholder="Ex: Eau" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Emoji *</label>
                    <input type="text" id="snackEmoji" class="form-input" placeholder="Ex: üíß" maxlength="2" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="snackDescription" class="form-input" rows="3" placeholder="Ex: Bouteille d'eau 50cl"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ID Produit * (unique)</label>
                    <input type="text" id="snackProductId" class="form-input" placeholder="Ex: eau" required>
                    <small style="color: #666; font-size: 12px;">Cet ID sera utilis√© pour identifier le produit dans les commandes</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Prix (‚Ç¨) *</label>
                    <input type="number" id="snackPrice" class="form-input" min="0" step="0.01" value="0" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button type="button" onclick="document.getElementById('snackModal').style.display = 'none'" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        Annuler
                    </button>
                    <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let pendingOrder = null; // Stocke la commande en attente
        let currentView = 'bachelor'; // Vue actuelle pour admins/membres
        let allClasses = []; // Stocke toutes les classes charg√©es
        let deadlineTimer = null; // Timer pour le compte √† rebours de la deadline
        let customFillings = []; // Fillings personnalis√©s
        let customSnacks = []; // Snacks personnalis√©s
        
        // Mettre √† jour le th√®me (fond et titre) selon le programme
        function updateTheme() {
            const program = getCurrentProgram();
            const body = document.body;
            const titleElement = document.getElementById('shop-title');
            
            // Mettre √† jour le fond
            body.classList.remove('bachelor-theme', 'master-theme');
            if (program === 'bachelor') {
                body.classList.add('bachelor-theme');
            } else {
                body.classList.add('master-theme');
            }
            
            // Mettre √† jour le titre
            if (titleElement) {
                if (program === 'bachelor') {
                    titleElement.textContent = 'üè™ Magasin EBS';
                } else {
                    titleElement.textContent = 'üè™ Le Magasin Des SMAQeurs bris√©s';
                }
            }
        }
        
        // Switch view between Bachelor and Master (for admins/members)
        async function switchViewShop(program) {
            currentView = program;
            updateViewButtonsShop();
            updateTheme(); // Mettre √† jour le th√®me
            
            console.log('View switched to:', program);
            
            // Recharger TOUTES les donn√©es pour synchroniser tous les onglets
            
            // 1. Recharger le stock (pour l'onglet restock et pour les commandes)
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'boss')) {
                await loadStockData();
            }
            
            // 2. Recharger les commandes admin (onglet admin)
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'member' || currentUser.role === 'boss')) {
                loadAllOrders();
            }
            
            // 3. Recharger mes commandes (onglet my-orders)
            if (currentUser) {
                loadMyOrders();
            }
            
            // 4. Recharger les produits (cr√™pes et snacks) dans l'onglet commande
            loadProductsForOrders();
            
            // 5. Recharger le stock et v√©rifier les boutons de commande (onglet orders)
            // Cela permet aux √©tudiants et admins de voir le bon stock apr√®s changement de vue
            setTimeout(async () => {
                await checkStockOnLoad();
            }, 300);
        }
        
        // Update view toggle buttons in shop
        function updateViewButtonsShop() {
            const bachelorBtn = document.getElementById('view-bachelor-shop');
            const masterBtn = document.getElementById('view-master-shop');
            
            if (bachelorBtn && masterBtn) {
                if (currentView === 'bachelor') {
                    bachelorBtn.style.background = '#667eea';
                    masterBtn.style.background = '#6c757d';
                } else {
                    bachelorBtn.style.background = '#6c757d';
                    masterBtn.style.background = '#667eea';
                }
            }
        }
        
        // Get current program for stock/orders
        function getCurrentProgram() {
            if (!currentUser) return 'bachelor';
            
            // Students are locked to their program
            if (currentUser.role === 'student') {
                return currentUser.program || 'bachelor';
            }
            
            // Admins/members/boss can switch views
            if (currentUser.role === 'admin' || currentUser.role === 'member' || currentUser.role === 'boss') {
                return currentView || 'bachelor';
            }
            
            return 'bachelor';
        }

        function showTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // D√©sactiver tous les boutons
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Afficher l'onglet s√©lectionn√©
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Charger le contenu de l'onglet
            if (tabName === 'orders') {
                // Recharger les produits dans la page de commande
                loadProductsForOrders();
            } else if (tabName === 'my-orders') {
                if (currentUser) {
                    loadMyOrders();
                } else {
                    document.getElementById('ordersTable').innerHTML = `
                        <div class="loading">Chargement de vos commandes...</div>
                    `;
                    // Attendre que currentUser soit charg√©
                    const checkUser = setInterval(() => {
                        if (currentUser) {
                            clearInterval(checkUser);
                            loadMyOrders();
                        }
                    }, 100);
                }
            } else if (tabName === 'my-account') {
                if (currentUser) {
                    loadMyAccount();
                } else {
                    document.getElementById('userAccount').innerHTML = `
                        <div class="loading">Chargement de vos informations...</div>
                    `;
                    // Attendre que currentUser soit charg√©
                    const checkUser = setInterval(() => {
                        if (currentUser) {
                            clearInterval(checkUser);
                            loadMyAccount();
                        }
                    }, 100);
                }
            } else if (tabName === 'admin') {
                if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'member' || currentUser.role === 'boss')) {
                    loadAllOrders();
                } else {
                    document.getElementById('adminOrdersTable').innerHTML = `
                        <div class="error">Acc√®s refus√©. Seuls les administrateurs, membres et BOSS peuvent acc√©der √† cette section.</div>
                    `;
                }
            } else if (tabName === 'restock') {
                if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'boss')) {
                    loadStockData();
                    // Charger l'historique des restocks
                    setTimeout(() => {
                        loadRestockHistory();
                    }, 500);
                } else {
                    const restockHistoryDiv = document.getElementById('restockHistory');
                    if (restockHistoryDiv) {
                        restockHistoryDiv.innerHTML = `
                            <div class="error">Acc√®s refus√©. Seuls les administrateurs et BOSS peuvent acc√©der √† cette section.</div>
                        `;
                    }
                }
            } else if (tabName === 'customization') {
                if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'boss')) {
                    loadCustomFillings();
                    loadCustomSnacks();
                } else {
                    document.getElementById('customization').innerHTML = `
                        <div class="error">Acc√®s refus√©. Seuls les administrateurs et BOSS peuvent acc√©der √† cette section.</div>
                    `;
                }
            }
        }

        function selectProduct(productName) {
            // Retirer la s√©lection de tous les produits
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // S√©lectionner le produit cliqu√©
            event.currentTarget.classList.add('selected');
        }

        async function showClassModal(product, price) {
            if (!currentUser) {
                alert('Veuillez vous connecter pour passer une commande');
                return;
            }

            // V√©rifier le stock avant d'afficher la modal
            const canOrder = await canOrderProduct(product);
            if (!canOrder) {
                const productName = getProductName(product);
                showMessage(`‚ùå D√©sol√©, plus de ${productName} disponibles ! Soit le stock est √©puis√©, soit la limite quotidienne est atteinte.`, 'error');
                return;
            }

            // Stocker la commande en attente
            pendingOrder = { product, price };
            
            // Afficher le produit s√©lectionn√©
            const productName = getProductName(product);
            document.getElementById('modal-selected-item-display').textContent = productName;
            
            // R√©initialiser la s√©lection de classe
            document.getElementById('selected-class-id').value = '';
            document.getElementById('selected-class-schedule-id').value = '';
            document.getElementById('selected-class-info').style.display = 'none';
            document.getElementById('modal-confirm-btn').disabled = true;
            
            // Afficher la modal d'abord
            document.getElementById('classModal').classList.add('show');
            
            // Afficher la section de s√©lection par d√©faut apr√®s un court d√©lai
            // pour s'assurer que la modal est bien rendue
            setTimeout(() => {
                showClassSelection();
            }, 50);
        }

        function hideClassModal() {
            document.getElementById('classModal').classList.remove('show');
            pendingOrder = null;
            // Reset class selection
            document.getElementById('selected-class-id').value = '';
            document.getElementById('selected-class-schedule-id').value = '';
            document.getElementById('selected-class-info').style.display = 'none';
            // Arr√™ter le compte √† rebours
            stopDeadlineWarning();
        }

        // S√©lectionner le vote
        function selectVote(vote) {
            document.getElementById('selected-vote').value = vote;
            
            // Mettre √† jour l'apparence des boutons
            const redBtn = document.getElementById('vote-red-btn');
            const greenBtn = document.getElementById('vote-green-btn');
            
            if (vote === 'red') {
                redBtn.style.border = '3px solid #fff';
                redBtn.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.5)';
                greenBtn.style.border = '3px solid transparent';
                greenBtn.style.boxShadow = 'none';
            } else {
                greenBtn.style.border = '3px solid #fff';
                greenBtn.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';
                redBtn.style.border = '3px solid transparent';
                redBtn.style.boxShadow = 'none';
            }
        }

        async function confirmOrder() {
            if (!pendingOrder) return;

            const classId = document.getElementById('selected-class-id').value;
            const scheduleIndex = parseInt(document.getElementById('selected-class-schedule-id').value);
            const vote = document.getElementById('selected-vote').value;

            if (!classId || isNaN(scheduleIndex)) {
                showMessage('Veuillez s√©lectionner une salle et un horaire', 'error');
                return;
            }
            
            if (!vote) {
                showMessage('Veuillez voter pour une liste (Rouge ou Verte)', 'error');
                return;
            }

            // Trouver les donn√©es de la classe
            const classData = allClasses.find(c => c.id === classId);
            if (!classData || !classData.schedules || !classData.schedules[scheduleIndex]) {
                showMessage('Erreur: salle ou horaire introuvable', 'error');
                return;
            }

            const schedule = classData.schedules[scheduleIndex];
            const startTime = schedule.startTime || '';
            const endTime = schedule.endTime || '';
            const deliveryTime = calculateDeliveryTime(startTime, endTime);
            const deadline = calculateDeadline(deliveryTime);

            // V√©rifier que la deadline n'est pas pass√©e
            const now = new Date();
            const deadlineDate = new Date(deadline);
            if (deadlineDate < now) {
                showMessage('‚ö†Ô∏è La deadline de commande est pass√©e. Veuillez s√©lectionner un autre horaire.', 'error');
                return;
            }

            try {
                // V√©rifier si la commande est possible avec les limitations
                const canOrder = await canOrderProduct(pendingOrder.product);
                if (!canOrder) {
                    const productName = getProductName(pendingOrder.product);
                    showMessage(`‚ùå D√©sol√©, plus de ${productName} disponibles ! Soit le stock est √©puis√©, soit la limite quotidienne est atteinte.`, 'error');
                    hideClassModal();
                    return;
                }

                const program = getCurrentProgram();
                const orderData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: `${currentUser.firstName} ${currentUser.lastName}`,
                    product: pendingOrder.product,
                    price: pendingOrder.price,
                    classroom: classData.room,
                    classId: classId,
                    scheduleIndex: scheduleIndex,
                    startTime: startTime,
                    endTime: endTime,
                    deliveryTime: deliveryTime.toISOString(),
                    deadline: deadline.toISOString(),
                    program: program,
                    vote: vote, // Ajouter le vote
                    status: 'pending',
                    createdAt: new Date(),
                    orderDate: new Date().toLocaleDateString('fr-FR'),
                    orderTime: new Date().toLocaleTimeString('fr-FR')
                };

                // Utiliser une transaction pour s'assurer que le stock est d√©cr√©ment√© atomiquement
                await db.runTransaction(async (transaction) => {
                    // V√©rifier le stock global pour le programme actuel
                    const stockRef = db.collection('stock').doc(program);
                    const stockDoc = await transaction.get(stockRef);
                    
                    if (!stockDoc.exists) {
                        throw new Error('Stock global non trouv√©');
                    }
                    
                    const currentGlobalStock = stockDoc.data().quantity || 0;
                    if (currentGlobalStock <= 0) {
                        throw new Error('Stock global insuffisant');
                    }
                    
                    // V√©rifier le status du filling pour le programme actuel
                    const fillingRef = db.collection('fillingStatus').doc(program);
                    const fillingDoc = await transaction.get(fillingRef);
                    
                    if (fillingDoc.exists) {
                        const fillingData = fillingDoc.data();
                        const fillingStatus = fillingData[pendingOrder.product];
                        
                        // Si limit√©, v√©rifier qu'il reste du filling
                        if (fillingStatus !== 'unlimited' && fillingStatus !== undefined) {
                            if (fillingStatus <= 0) {
                                throw new Error('Filling insuffisant pour ce type de cr√™pe');
                            }
                            
                            // D√©cr√©menter le filling
                            const newFillingData = { ...fillingData };
                            newFillingData[pendingOrder.product] = fillingStatus - 1;
                            newFillingData.lastUpdated = new Date();
                            
                            transaction.set(fillingRef, newFillingData);
                        }
                    }
                    
                    // D√©cr√©menter le stock global
                    transaction.update(stockRef, {
                        quantity: currentGlobalStock - 1,
                        lastUpdated: new Date()
                    });
                    
                    // Ajouter la commande
                    transaction.set(db.collection('orders').doc(), orderData);
                });
                
                // Afficher un message de succ√®s
                showMessage(`Commande pass√©e avec succ√®s ! Livraison pr√©vue en salle ${classData.room} √† ${formatTime(deliveryTime)}`, 'success');
                
                // Fermer la modal
                hideClassModal();
                
                // Recharger les donn√©es de stock
                setTimeout(async () => {
                    await loadStockData();
                    checkStockOnLoad();
                }, 500);
                
                // Recharger les commandes si on est sur l'onglet
                if (document.getElementById('my-orders').classList.contains('active')) {
                    loadMyOrders();
                }
                
            } catch (error) {
                console.error('Erreur lors de la commande:', error);
                if (error.message === 'Stock insuffisant') {
                    showMessage('‚ùå D√©sol√©, nous sommes en rupture de stock ! Plus de cr√™pes disponibles pour le moment.', 'error');
                } else {
                    showMessage('Erreur lors de la commande: ' + error.message, 'error');
                }
                hideClassModal();
            }
        }

        function placeOrder(productName, price) {
            // Cette fonction est maintenant remplac√©e par showClassModal
            showClassModal(productName, price);
        }

        async function loadMyOrders() {
            if (!currentUser) {
                document.getElementById('ordersTable').innerHTML = `
                    <div class="loading">Chargement de vos commandes...</div>
                `;
                return;
            }

            try {
                const program = getCurrentProgram();
                
                // Filtrer les commandes par utilisateur ET programme
                const querySnapshot = await db.collection('orders')
                    .where('userId', '==', currentUser.uid)
                    .where('program', '==', program)
                    .get();
                
                // Trier manuellement par date
                const orders = [];
                querySnapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                orders.sort((a, b) => {
                    const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                    const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                    return dateB - dateA;
                });
                
                if (orders.length === 0) {
                    document.getElementById('ordersTable').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>Aucune commande</h3>
                            <p>Vous n'avez pas encore pass√© de commande.</p>
                        </div>
                    `;
                    return;
                }

                let tableHTML = `
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Produit</th>
                                <th>Prix</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                orders.forEach((order) => {
                    const statusClass = getStatusClass(order.status);
                    const statusText = getStatusText(order.status);
                    
                    tableHTML += `
                        <tr>
                            <td>${order.orderDate} ${order.orderTime}</td>
                            <td>${getProductName(order.product)}</td>
                            <td>${order.price === 0 ? 'FREE' : order.price + '‚Ç¨'}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                document.getElementById('ordersTable').innerHTML = tableHTML;
                
            } catch (error) {
                console.error('Erreur lors du chargement des commandes:', error);
                document.getElementById('ordersTable').innerHTML = `
                    <div class="error">Erreur lors du chargement de vos commandes</div>
                `;
            }
        }

        async function loadMyAccount() {
            if (!currentUser) {
                document.getElementById('userAccount').innerHTML = `
                    <div class="loading">Chargement de vos informations...</div>
                `;
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    console.log('Donn√©es utilisateur:', userData);
                    console.log('Pr√©nom:', userData.firstName);
                    console.log('Nom:', userData.lastName);
                    
                    // Si les donn√©es sont vides, proposer de les corriger
                    if (!userData.firstName || !userData.lastName || 
                        userData.firstName.trim() === '' || userData.lastName.trim() === '') {
                        console.log('Donn√©es manquantes d√©tect√©es, proposition de correction...');
                        showDataCorrectionModal(userData);
                        return;
                    }
                    
                    console.log('Affichage du compte avec bouton d√©connexion');
                    document.getElementById('userAccount').innerHTML = `
                        <div class="user-info">
                            <div class="info-card">
                                <div class="info-label">Nom complet</div>
                                <div class="info-value">${(userData.firstName && userData.firstName.trim()) || 'Non d√©fini'} ${(userData.lastName && userData.lastName.trim()) || 'Non d√©fini'}</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Email</div>
                                <div class="info-value">${currentUser.email}</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">R√¥le</div>
                                <div class="info-value">${getRoleText(userData.role)}</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Membre depuis</div>
                                <div class="info-value">${userData.createdAt ? (userData.createdAt.toDate ? userData.createdAt.toDate().toLocaleDateString('fr-FR') : new Date(userData.createdAt).toLocaleDateString('fr-FR')) : 'N/A'}</div>
                            </div>
                            <div class="info-card">
                                <button onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%;">
                                    üö™ Se d√©connecter
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('userAccount').innerHTML = `
                        <div class="error">Profil utilisateur non trouv√©</div>
                    `;
                }
            } catch (error) {
                console.error('Erreur lors du chargement du compte:', error);
                document.getElementById('userAccount').innerHTML = `
                    <div class="error">Erreur lors du chargement de vos informations</div>
                `;
            }
        }

        function getProductName(product) {
            const names = {
                'crepes-sucre': 'Cr√™pes Sucre',
                'crepes-nutella': 'Cr√™pes Nutella',
                'crepes-confiture': 'Cr√™pes Confiture',
                'crepes': 'Cr√™pes', // Ancien format pour compatibilit√©
                'cookie': 'Cookie',
                'gaufre': 'Gaufre'
            };
            return names[product] || product;
        }

        function getStatusClass(status) {
            const classes = {
                'pending': 'status-pending',
                'confirmed': 'status-confirmed',
                'delivered': 'status-delivered'
            };
            return classes[status] || 'status-pending';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'En attente',
                'confirmed': 'Confirm√©e',
                'delivered': 'Livr√©e'
            };
            return texts[status] || 'En attente';
        }

        function getRoleText(role) {
            const texts = {
                'admin': 'Administrateur',
                'student': '√âtudiant',
                'member': 'Membre',
                'boss': 'BOSS'
            };
            return texts[role] || 'Utilisateur';
        }

        function showMessage(message, type) {
            const messageEl = document.createElement('div');
            messageEl.className = type === 'success' ? 'success' : 'error';
            messageEl.textContent = message;
            
            const container = document.querySelector('.tab-content');
            container.insertBefore(messageEl, container.firstChild);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        function showDataCorrectionModal(userData) {
            document.getElementById('userAccount').innerHTML = `
                <div class="user-info">
                    <div class="info-card" style="background: #fff3cd; border-left-color: #ffc107;">
                        <div class="info-label">‚ö†Ô∏è Donn√©es manquantes</div>
                        <div class="info-value">Vos pr√©nom et nom ne sont pas renseign√©s. Veuillez les compl√©ter :</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Pr√©nom</div>
                        <input type="text" id="firstNameInput" placeholder="Votre pr√©nom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;">
                    </div>
                    <div class="info-card">
                        <div class="info-label">Nom</div>
                        <input type="text" id="lastNameInput" placeholder="Votre nom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;">
                    </div>
                    <div class="info-card">
                        <div class="info-label">Email</div>
                        <div class="info-value">${currentUser.email}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">R√¥le</div>
                        <div class="info-value">${getRoleText(userData.role)}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Membre depuis</div>
                        <div class="info-value">${userData.createdAt ? (userData.createdAt.toDate ? userData.createdAt.toDate().toLocaleDateString('fr-FR') : new Date(userData.createdAt).toLocaleDateString('fr-FR')) : 'N/A'}</div>
                    </div>
                    <div class="info-card">
                        <button onclick="updateUserData()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; margin-bottom: 10px;">
                            Sauvegarder mes informations
                        </button>
                    </div>
                    <div class="info-card">
                        <button onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%;">
                            üö™ Se d√©connecter
                        </button>
                    </div>
                </div>
            `;
        }

        async function updateUserData() {
            const firstName = document.getElementById('firstNameInput').value.trim();
            const lastName = document.getElementById('lastNameInput').value.trim();
            
            if (!firstName || !lastName) {
                showMessage('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    firstName: firstName,
                    lastName: lastName
                });
                
                // Mettre √† jour currentUser
                currentUser.firstName = firstName;
                currentUser.lastName = lastName;
                
                showMessage('Informations mises √† jour avec succ√®s !', 'success');
                
                // Recharger l'onglet
                setTimeout(() => {
                    loadMyAccount();
                }, 1000);
                
            } catch (error) {
                console.error('Erreur lors de la mise √† jour:', error);
                showMessage('Erreur lors de la mise √† jour: ' + error.message, 'error');
            }
        }
        
        // Fonction de d√©connexion
        async function logout() {
            if (!confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                return;
            }
            
            try {
                // Nettoyer toutes les donn√©es de session
                currentUser = null;
                currentView = 'bachelor';
                
                // D√©connexion Firebase
                await auth.signOut();
                
                // Nettoyer le localStorage et sessionStorage
                localStorage.clear();
                sessionStorage.clear();
                
                // Rediriger vers la page d'authentification
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Erreur lors de la d√©connexion:', error);
                showMessage('Erreur lors de la d√©connexion: ' + error.message, 'error');
            }
        }

        async function loadAllOrders() {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'member' && currentUser.role !== 'boss')) {
                document.getElementById('adminOrdersTable').innerHTML = `
                    <div class="error">Acc√®s refus√©. Seuls les administrateurs, membres et BOSS peuvent acc√©der √† cette section.</div>
                `;
                return;
            }

            try {
                const program = getCurrentProgram();
                
                // Filtrer les commandes par programme
                const querySnapshot = await db.collection('orders')
                    .where('program', '==', program)
                    .get();
                
                if (querySnapshot.empty) {
                    document.getElementById('adminOrdersTable').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>Aucune commande</h3>
                            <p>Aucune commande n'a √©t√© pass√©e pour le moment.</p>
                        </div>
                    `;
                    return;
                }

                // Convertir en tableau et trier par date
                const orders = [];
                querySnapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                orders.sort((a, b) => {
                    const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                    const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                    return dateB - dateA;
                });

                displayAdminOrders(orders, '');
                
            } catch (error) {
                console.error('Erreur lors du chargement des commandes admin:', error);
                document.getElementById('adminOrdersTable').innerHTML = `
                    <div class="error">Erreur lors du chargement des commandes: ${error.message}</div>
                `;
            }
        }

        function displayAdminOrders(orders, classFilter = '') {
            // TOUJOURS grouper par classe ET par heure de livraison
            // Si un filtre de classe est appliqu√©, filtrer d'abord puis grouper
            let filteredOrders = orders;
            
            if (classFilter && classFilter.trim() !== '') {
                // Filtrer les commandes par classe
                filteredOrders = orders.filter(order => {
                    const classroom = order.classroom || order.classNumber || '';
                    return classroom.toString().includes(classFilter.trim());
                });
            }
            
            // Grouper les commandes par classe et heure de livraison
            const groups = {};
            filteredOrders.forEach((order) => {
                const classroom = order.classroom || order.classNumber || 'N/A';
                const deliveryTime = order.deliveryTime ? 
                    (order.deliveryTime.toDate ? order.deliveryTime.toDate() : new Date(order.deliveryTime)) : 
                    null;
                const deliveryTimeStr = deliveryTime ? formatTime(deliveryTime) : 'N/A';
                const groupKey = `${classroom}_${deliveryTimeStr}`;
                
                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        classroom: classroom,
                        deliveryTime: deliveryTimeStr,
                        orders: []
                    };
                }
                groups[groupKey].orders.push(order);
            });
            
            // Trier les groupes : d'abord par salle, puis par heure de livraison
            const sortedGroups = Object.values(groups).sort((a, b) => {
                // Comparer d'abord par salle
                const classroomA = a.classroom.toString();
                const classroomB = b.classroom.toString();
                if (classroomA !== classroomB) {
                    return classroomA.localeCompare(classroomB, undefined, { numeric: true, sensitivity: 'base' });
                }
                // Si m√™me salle, comparer par heure
                if (a.deliveryTime === 'N/A' && b.deliveryTime === 'N/A') return 0;
                if (a.deliveryTime === 'N/A') return 1;
                if (b.deliveryTime === 'N/A') return -1;
                return a.deliveryTime.localeCompare(b.deliveryTime);
            });
            
            let tableHTML = '';
            
            if (sortedGroups.length === 0) {
                tableHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>Aucune commande</h3>
                        <p>Aucune commande ne correspond aux crit√®res de filtrage.</p>
                    </div>
                `;
            } else {
                sortedGroups.forEach((group, groupIndex) => {
                    // En-t√™te du groupe
                    tableHTML += `
                        <div style="margin-bottom: 30px; border: 2px solid #007bff; border-radius: 10px; overflow: hidden;">
                            <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0; font-size: 1.3rem; font-weight: bold;">
                                        üìç Salle ${group.classroom} - üïê Livraison: ${group.deliveryTime}
                                    </h3>
                                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                                        ${group.orders.length} commande(s)
                                    </p>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <button onclick="selectGroupOrders('group_${groupIndex}')" style="background: white; color: #007bff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        ‚úÖ S√©lectionner tout le groupe
                                    </button>
                                    <button onclick="deleteGroupOrders('${group.classroom}', '${group.deliveryTime}', ${group.orders.length})" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        üóëÔ∏è Supprimer classe
                                    </button>
                                </div>
                            </div>
                            <table class="orders-table" style="margin: 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 40px; text-align: center;">
                                            <input type="checkbox" class="group-checkbox" data-group="group_${groupIndex}" onchange="toggleGroup('group_${groupIndex}', this.checked)">
                                        </th>
                                        <th>Date</th>
                                        <th>Utilisateur</th>
                                        <th>Email</th>
                                        <th>Salle</th>
                                        <th>Produit</th>
                                        <th>Prix</th>
                                        <th>Vote</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Commandes du groupe
                    group.orders.forEach((order) => {
                        const statusClass = getStatusClass(order.status);
                        const statusText = getStatusText(order.status);
                        
                        const orderDate = order.orderDate || (order.createdAt ? 
                            (order.createdAt.toDate ? order.createdAt.toDate().toLocaleDateString() : new Date(order.createdAt).toLocaleDateString()) : 
                            'N/A');
                        const orderTime = order.orderTime || (order.createdAt ? 
                            (order.createdAt.toDate ? order.createdAt.toDate().toLocaleTimeString() : new Date(order.createdAt).toLocaleTimeString()) : 
                            '');
                        const userName = order.userName || 'N/A';
                        const userEmail = order.userEmail || 'N/A';
                        const classNumber = order.classroom || order.classNumber || 'N/A';
                        const product = getProductName(order.product) || 'N/A';
                        const price = order.price !== undefined ? (order.price === 0 ? 'FREE' : order.price + '‚Ç¨') : 'N/A';
                        const vote = order.vote || 'N/A';
                        const voteDisplay = vote === 'red' ? '<span style="color: #dc3545; font-weight: bold;">üî¥ Rouge</span>' : 
                                           vote === 'green' ? '<span style="color: #28a745; font-weight: bold;">üü¢ Verte</span>' : 
                                           'N/A';
                        
                        tableHTML += `
                            <tr>
                                <td style="text-align: center;">
                                    <input type="checkbox" class="order-checkbox group_${groupIndex}" data-order-id="${order.id}" onchange="updateBulkActions()">
                                </td>
                                <td>${orderDate} ${orderTime}</td>
                                <td>${userName}</td>
                                <td>${userEmail}</td>
                                <td><strong style="color: #007bff; font-size: 1.1rem;">${classNumber}</strong></td>
                                <td>${product}</td>
                                <td>${price}</td>
                                <td>${voteDisplay}</td>
                                <td style="position: relative; padding: 8px; overflow: visible;">
                                    <span class="status-badge-clickable ${statusClass}" style="position: relative; z-index: 1;" onclick="showStatusDropdown('${order.id}', event)">
                                        ${statusText}
                                    </span>
                                    <div id="statusDropdown_${order.id}" class="status-dropdown-menu" style="display: none !important;">
                                        <div class="status-dropdown-item" onclick="updateOrderStatus('${order.id}', 'pending'); event.stopPropagation();">En attente</div>
                                        <div class="status-dropdown-item" onclick="updateOrderStatus('${order.id}', 'confirmed'); event.stopPropagation();">Confirm√©e</div>
                                        <div class="status-dropdown-item" onclick="updateOrderStatus('${order.id}', 'delivered'); event.stopPropagation();">Livr√©e</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
            }
            
            document.getElementById('adminOrdersTable').innerHTML = tableHTML;
        }
        
        function selectGroupOrders(groupId) {
            const checkboxes = document.querySelectorAll(`.order-checkbox.${groupId}`);
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
            updateBulkActions();
        }
        
        function toggleGroup(groupId, checked) {
            const checkboxes = document.querySelectorAll(`.order-checkbox.${groupId}`);
            checkboxes.forEach(cb => {
                cb.checked = checked;
            });
            updateBulkActions();
        }
        
        // Supprimer toutes les commandes d'un groupe (classe + horaire)
        async function deleteGroupOrders(classroom, deliveryTime, orderCount) {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'member' && currentUser.role !== 'boss')) {
                showMessage('Seuls les administrateurs, membres et BOSS peuvent supprimer des commandes', 'error');
                return;
            }
            
            // Confirmation avec d√©tails
            const confirmMessage = `‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer toutes les commandes de la salle ${classroom} √† ${deliveryTime} ?\n\nCette action supprimera ${orderCount} commande(s) de mani√®re d√©finitive.\n\nCette action est irr√©versible !`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // R√©cup√©rer toutes les commandes pour trouver celles qui correspondent
                const program = getCurrentProgram();
                let querySnapshot;
                try {
                    querySnapshot = await db.collection('orders')
                        .where('program', '==', program)
                        .get();
                } catch (error) {
                    querySnapshot = await db.collection('orders').get();
                }
                
                // Filtrer les commandes du groupe
                const ordersToDelete = [];
                querySnapshot.forEach((doc) => {
                    const orderData = { id: doc.id, ...doc.data() };
                    
                    // Filtrer par programme si n√©cessaire
                    if (orderData.program && orderData.program !== program) {
                        return;
                    }
                    
                    // V√©rifier si la commande correspond √† la salle et l'horaire
                    const orderClassroom = orderData.classroom || orderData.classNumber || '';
                    const orderDeliveryTime = orderData.deliveryTime ? 
                        (orderData.deliveryTime.toDate ? formatTime(orderData.deliveryTime.toDate()) : formatTime(new Date(orderData.deliveryTime))) : 
                        null;
                    
                    if (orderClassroom.toString() === classroom.toString() && orderDeliveryTime === deliveryTime) {
                        ordersToDelete.push(doc.id);
                    }
                });
                
                // Supprimer toutes les commandes
                const deletePromises = ordersToDelete.map(orderId => 
                    db.collection('orders').doc(orderId).delete()
                );
                
                await Promise.all(deletePromises);
                
                showMessage(`‚úÖ ${ordersToDelete.length} commande(s) supprim√©e(s) avec succ√®s`, 'success');
                
                // Recharger le tableau
                loadAllOrders();
                
            } catch (error) {
                console.error('Erreur lors de la suppression des commandes:', error);
                showMessage('‚ùå Erreur lors de la suppression: ' + error.message, 'error');
            }
        }

        // Fonction pour afficher le dropdown de statut
        function showStatusDropdown(orderId, event) {
            event.stopPropagation();
            
            // Fermer tous les autres dropdowns
            document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
                if (menu.id !== `statusDropdown_${orderId}`) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle le dropdown actuel
            const dropdown = document.getElementById(`statusDropdown_${orderId}`);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }
        
        // Fermer les dropdowns quand on clique ailleurs
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.status-badge-clickable') && !event.target.closest('.status-dropdown-menu')) {
                document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
        
        async function updateOrderStatus(orderId, newStatus) {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'member' && currentUser.role !== 'boss')) {
                showMessage('Seuls les administrateurs, membres et BOSS peuvent modifier les statuts', 'error');
                return;
            }
            
            try {
                await db.collection('orders').doc(orderId).update({
                    status: newStatus
                });
                
                showMessage(`Statut de la commande mis √† jour: ${getStatusText(newStatus)}`, 'success');
                
                // Fermer le dropdown
                const dropdown = document.getElementById(`statusDropdown_${orderId}`);
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
                
                // Recharger le tableau
                loadAllOrders();
                
            } catch (error) {
                console.error('Erreur lors de la mise √† jour du statut:', error);
                showMessage('Erreur lors de la mise √† jour du statut: ' + error.message, 'error');
            }
        }

        function toggleFilters() {
            const filtersContent = document.getElementById('filtersContent');
            const filterArrow = document.getElementById('filterArrow');
            
            if (filtersContent.style.display === 'none') {
                filtersContent.style.display = 'block';
                filterArrow.textContent = '‚ñ≤';
            } else {
                filtersContent.style.display = 'none';
                filterArrow.textContent = '‚ñº';
            }
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const productFilter = document.getElementById('productFilter').value;
            const classFilter = document.getElementById('classFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            
            // Recharger toutes les commandes avec les filtres
            loadAllOrdersWithFilters(statusFilter, productFilter, classFilter, sortFilter);
        }

        async function loadAllOrdersWithFilters(statusFilter, productFilter, classFilter, sortFilter) {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'member' && currentUser.role !== 'boss')) return;

            try {
                const program = getCurrentProgram();
                
                // Filtrer d'abord par programme
                let querySnapshot;
                try {
                    querySnapshot = await db.collection('orders')
                        .where('program', '==', program)
                        .get();
                } catch (error) {
                    // Si l'index composite n'existe pas, r√©cup√©rer toutes les commandes et filtrer en JavaScript
                    console.log('Index composite manquant, filtrage en JavaScript...');
                    querySnapshot = await db.collection('orders').get();
                }
                
                if (querySnapshot.empty) {
                    document.getElementById('adminOrdersTable').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>Aucune commande</h3>
                            <p>Aucune commande n'a √©t√© pass√©e pour le moment.</p>
                        </div>
                    `;
                    return;
                }

                // Convertir en tableau
                let orders = [];
                querySnapshot.forEach((doc) => {
                    const orderData = { id: doc.id, ...doc.data() };
                    // Filtrer par programme si on a r√©cup√©r√© toutes les commandes
                    if (!orderData.program || orderData.program === program) {
                        orders.push(orderData);
                    }
                });

                // Appliquer les filtres (sauf classFilter qui sera g√©r√© par displayAdminOrders)
                if (statusFilter) {
                    orders = orders.filter(order => order.status === statusFilter);
                }
                
                if (productFilter) {
                    orders = orders.filter(order => order.product === productFilter);
                }
                
                // Note: classFilter est pass√© √† displayAdminOrders qui g√®re le filtrage ET le groupement

                // Appliquer le tri
                orders.sort((a, b) => {
                    switch (sortFilter) {
                        case 'date-asc':
                            const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                            const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                            return dateA - dateB;
                        case 'date-desc':
                            const dateA2 = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                            const dateB2 = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                            return dateB2 - dateA2;
                        case 'user':
                            return (a.userName || '').localeCompare(b.userName || '');
                        case 'product':
                            return (a.product || '').localeCompare(b.product || '');
                        case 'status':
                            return (a.status || '').localeCompare(b.status || '');
                        default:
                            return 0;
                    }
                });

                // Passer le classFilter √† displayAdminOrders qui g√®re le filtrage et le groupement
                displayAdminOrders(orders, classFilter);
                
            } catch (error) {
                console.error('Erreur lors du chargement des commandes filtr√©es:', error);
                document.getElementById('adminOrdersTable').innerHTML = `
                    <div class="error">Erreur lors du chargement des commandes: ${error.message}</div>
                `;
            }
        }

        async function loadUser() {
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'auth.html';
                    return;
                }

                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        // V√©rifier si le compte n'est pas supprim√©
                        if (userData.deleted) {
                            showMessage('Ce compte a √©t√© supprim√©. Contactez un administrateur.', 'error');
                            auth.signOut().then(() => {
                                window.location.href = 'auth.html';
                            });
                            return;
                        }

                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            firstName: userData.firstName || '',
                            lastName: userData.lastName || '',
                            role: userData.role || 'student',
                            program: userData.program || 'bachelor'
                        };
                        
                        // Attribuer automatiquement le r√¥le BOSS √† pascalmartinlalande@gmail.com
                        if (user.email === 'pascalmartinlalande@gmail.com' && userData.role !== 'boss') {
                            await db.collection('users').doc(user.uid).update({
                                role: 'boss'
                            });
                            currentUser.role = 'boss';
                            console.log('‚úÖ R√¥le BOSS attribu√© automatiquement');
                            alert('‚úÖ R√¥le BOSS attribu√© ! La page va se recharger...');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        }
                        
                        // Initialize currentView based on user role
                        if (currentUser.role === 'admin' || currentUser.role === 'member' || currentUser.role === 'boss') {
                            currentView = currentView || 'bachelor';
                        } else {
                            currentView = currentUser.program || 'bachelor';
                        }
                    } else {
                        // Si le profil n'existe pas, le cr√©er avec des valeurs par d√©faut
                        console.log('Profil non trouv√©, cr√©ation automatique...');
                        await db.collection('users').doc(user.uid).set({
                            firstName: 'Utilisateur',
                            lastName: 'Nouveau',
                            email: user.email,
                            role: 'student',
                            createdAt: new Date(),
                            emailVerified: user.emailVerified
                        });
                        
                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            firstName: 'Utilisateur',
                            lastName: 'Nouveau',
                            role: 'student',
                            program: 'bachelor'
                        };
                        currentView = 'bachelor';
                        
                        showMessage('Profil cr√©√© automatiquement. Vous pouvez le modifier dans "Mon Compte".', 'success');
                    }
                    
                    console.log('Utilisateur charg√©:', currentUser);
                    
                    // Afficher l'onglet Livraison si c'est un admin ou membre
                    if (currentUser.role === 'admin' || currentUser.role === 'member' || currentUser.role === 'boss') {
                        document.querySelector('button[onclick="showTab(\'admin\')"]').style.display = 'block';
                    }
                    
                    // Afficher le bouton View pour admins/membres/boss (dans la section orders)
                    const viewToggleShop = document.getElementById('view-toggle-shop');
                    if (viewToggleShop) {
                        if (currentUser.role === 'admin' || currentUser.role === 'member' || currentUser.role === 'boss') {
                            viewToggleShop.style.display = 'flex';
                            updateViewButtonsShop();
                        } else {
                            viewToggleShop.style.display = 'none';
                        }
                    }
                    
                    // Mettre √† jour le th√®me (fond et titre) selon le programme
                    updateTheme();
                    
                    // Charger les produits dans la page de commande
                    loadProductsForOrders();
                    
                    // Afficher l'onglet Restock et Personnalisation pour les admins et BOSS
                    if (currentUser.role === 'admin' || currentUser.role === 'boss') {
                        document.querySelector('button[onclick="showTab(\'restock\')"]').style.display = 'block';
                        document.querySelector('button[onclick="showTab(\'customization\')"]').style.display = 'block';
                    }
                    
                    // Afficher le lien priv√© SEULEMENT pour les BOSS
                    if (currentUser.role === 'boss') {
                        document.querySelector('a[href="private.html"]').style.display = 'block';
                    } else {
                        document.querySelector('a[href="private.html"]').style.display = 'none';
                    }
                    
                    // Recharger les onglets si ils sont actifs
                    if (document.getElementById('my-orders').classList.contains('active')) {
                        loadMyOrders();
                    }
                    if (document.getElementById('my-account').classList.contains('active')) {
                        loadMyAccount();
                    }
                    if (document.getElementById('admin').classList.contains('active')) {
                        loadAllOrders();
                    }
                    if (document.getElementById('restock').classList.contains('active')) {
                        loadStockData();
                    }
                    
                    // Recharger le stock et v√©rifier les boutons de commande apr√®s chargement utilisateur
                    setTimeout(async () => {
                        await checkStockOnLoad();
                    }, 500);
                } catch (error) {
                    console.error('Erreur lors du chargement du profil:', error);
                    showMessage('Erreur lors du chargement du profil', 'error');
                }
            });
        }

        // Charger l'utilisateur au d√©marrage
        // Fonction manuelle pour forcer l'attribution du r√¥le BOSS (√† appeler depuis la console)
        window.forceSetBoss = async function() {
            const bossEmail = 'pascalmartinlalande@gmail.com';
            try {
                const user = auth.currentUser;
                if (!user) {
                    alert('Vous devez √™tre connect√©');
                    return;
                }
                
                if (user.email !== bossEmail) {
                    alert('Cette fonction est r√©serv√©e √† ' + bossEmail);
                    return;
                }
                
                await db.collection('users').doc(user.uid).update({
                    role: 'boss'
                });
                alert('‚úÖ R√¥le BOSS attribu√© ! Rechargez la page.');
                console.log('‚úÖ R√¥le BOSS attribu√© √†:', bossEmail);
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur: ' + error.message);
            }
        };
        
        loadUser();

        // V√©rifier le stock au chargement de la page
        async function checkStockOnLoad() {
            try {
                // V√©rifier chaque produit
                const products = ['crepes-sucre', 'crepes-nutella', 'crepes-confiture'];
                let hasAnyStock = false;
                
                for (const product of products) {
                    const canOrder = await canOrderProduct(product);
                    const button = document.querySelector(`button[onclick*="${product}"]`);
                    
                    if (button) {
                        if (!canOrder) {
                            button.disabled = true;
                            button.textContent = 'Rupture de stock';
                            button.style.background = '#ccc';
                            button.style.cursor = 'not-allowed';
                        } else {
                            button.disabled = false;
                            button.textContent = 'Commander';
                            button.style.background = '#667eea';
                            button.style.cursor = 'pointer';
                            hasAnyStock = true;
                        }
                    }
                }
                
                // Afficher/masquer le message de stock √©puis√©
                const noStockMessage = document.getElementById('noStockMessage');
                if (noStockMessage) {
                    if (hasAnyStock) {
                        noStockMessage.style.display = 'none';
                    } else {
                        noStockMessage.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la v√©rification du stock:', error);
            }
        }

        // V√©rifier le stock apr√®s le chargement de l'utilisateur
        setTimeout(checkStockOnLoad, 1000);

        // Variables globales pour le stock
        let currentStock = 0;
        let fillingStatus = {
            'crepes-sucre': 'unlimited', // 'unlimited' ou nombre
            'crepes-nutella': 'unlimited',
            'crepes-confiture': 'unlimited'
        };

        // Fonctions pour la gestion du stock
        async function loadStockData() {
            try {
                const program = getCurrentProgram();
                
                // Charger le stock global pour le programme actuel
                const stockDoc = await db.collection('stock').doc(program).get();
                if (stockDoc.exists) {
                    currentStock = stockDoc.data().quantity || 0;
                } else {
                    currentStock = 0;
                    await db.collection('stock').doc(program).set({
                        quantity: 0,
                        lastUpdated: new Date(),
                        program: program
                    });
                }
                
                // Charger les status des fillings pour le programme actuel
                const fillingDoc = await db.collection('fillingStatus').doc(program).get();
                if (fillingDoc.exists) {
                    const data = fillingDoc.data();
                    fillingStatus = {
                        'crepes-sucre': data['crepes-sucre'] || 'unlimited',
                        'crepes-nutella': data['crepes-nutella'] || 'unlimited',
                        'crepes-confiture': data['crepes-confiture'] || 'unlimited'
                    };
                } else {
                    fillingStatus = {
                        'crepes-sucre': 'unlimited',
                        'crepes-nutella': 'unlimited',
                        'crepes-confiture': 'unlimited'
                    };
                    await db.collection('fillingStatus').doc(program).set({
                        ...fillingStatus,
                        program: program
                    });
                }
                
                // Mettre √† jour l'affichage
                updateStockDisplay();
                
                // Charger le stock des snacks
                await loadSnacksStock();
                
                // Charger l'historique des restocks
                loadRestockHistory();
                
            } catch (error) {
                console.error('Erreur lors du chargement du stock:', error);
                showMessage('Erreur lors du chargement du stock: ' + error.message, 'error');
            }
        }

        async function addStock() {
            const quantity = parseInt(document.getElementById('restockQuantity').value);
            
            if (!quantity || quantity <= 0) {
                showMessage('Veuillez entrer une quantit√© valide', 'error');
                return;
            }
            
            if (quantity > 1000) {
                showMessage('Quantit√© maximale: 1000 cr√™pes', 'error');
                return;
            }
            
            try {
                const program = getCurrentProgram();
                const previousStock = currentStock;
                
                // Mettre √† jour le stock global pour le programme actuel
                const newStock = currentStock + quantity;
                
                // Sauvegarder en base
                await db.collection('stock').doc(program).set({
                    quantity: newStock,
                    lastUpdated: new Date(),
                    program: program
                });
                
                // Mettre √† jour les variables locales
                currentStock = newStock;
                
                // Mettre √† jour l'affichage
                updateStockDisplay();
                document.getElementById('restockQuantity').value = '';
                
                // Enregistrer l'historique du restock avec le programme
                await db.collection('restockHistory').add({
                    type: 'crepes',
                    quantity: quantity,
                    previousStock: previousStock,
                    newStock: newStock,
                    program: program,
                    adminId: currentUser.uid,
                    adminName: currentUser.firstName + ' ' + currentUser.lastName,
                    timestamp: new Date()
                });
                
                showMessage(`${quantity} cr√™pes ajout√©es au stock ${program === 'bachelor' ? 'Bachelor' : 'Master'} ! Nouveau stock: ${newStock}`, 'success');
                
                // Recharger l'historique
                loadRestockHistory();
                
                // Recharger l'affichage du stock
                updateStockDisplay();
                
                // Recharger l'√©tat des boutons de commande pour TOUS (√©tudiants et admins)
                setTimeout(async () => {
                    await checkStockOnLoad();
                }, 500);
                
            } catch (error) {
                console.error('Erreur lors de l\'ajout du stock:', error);
                showMessage('Erreur lors de l\'ajout du stock: ' + error.message, 'error');
            }
        }

        async function loadRestockHistory() {
            const restockHistoryDiv = document.getElementById('restockHistory');
            if (!restockHistoryDiv) {
                console.error('Element restockHistory non trouv√©');
                return;
            }
            
            try {
                const program = getCurrentProgram();
                if (!program) {
                    restockHistoryDiv.innerHTML = `
                        <div class="error">Erreur: Programme non d√©fini</div>
                    `;
                    return;
                }
                
                // Filtrer l'historique par programme
                // Note: Si l'index composite n'existe pas, on r√©cup√®re tout et on filtre/trie en JavaScript
                let historySnapshot;
                try {
                    historySnapshot = await db.collection('restockHistory')
                        .where('program', '==', program)
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                } catch (error) {
                    // Si l'index composite n'existe pas, r√©cup√©rer tout et filtrer en JavaScript
                    console.warn('Index composite manquant, r√©cup√©ration de tous les restocks:', error);
                    const allHistory = await db.collection('restockHistory').get();
                    const filteredDocs = [];
                    allHistory.forEach(doc => {
                        const data = doc.data();
                        if (data.program === program) {
                            filteredDocs.push({ id: doc.id, data: data });
                        }
                    });
                    // Trier par timestamp (le plus r√©cent en premier)
                    filteredDocs.sort((a, b) => {
                        const timeA = a.data.timestamp?.toDate ? a.data.timestamp.toDate().getTime() : 
                                     (a.data.timestamp?.getTime ? a.data.timestamp.getTime() : 
                                     (new Date(a.data.timestamp || 0)).getTime());
                        const timeB = b.data.timestamp?.toDate ? b.data.timestamp.toDate().getTime() : 
                                     (b.data.timestamp?.getTime ? b.data.timestamp.getTime() : 
                                     (new Date(b.data.timestamp || 0)).getTime());
                        return timeB - timeA; // Descendant
                    });
                    // Limiter √† 10
                    filteredDocs.splice(10);
                    
                    if (filteredDocs.length === 0) {
                        restockHistoryDiv.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #666;">
                                Aucun restock effectu√© pour le moment (${program === 'bachelor' ? 'Bachelor' : 'Master'})
                            </div>
                        `;
                        return;
                    }
                    
                    let historyHTML = `<div style="display: grid; gap: 10px;">`;
                    filteredDocs.forEach(item => {
                        const data = item.data;
                        const date = data.timestamp?.toDate ? data.timestamp.toDate() : 
                                   (data.timestamp?.getTime ? new Date(data.timestamp) : 
                                   new Date(data.timestamp || new Date()));
                        const dateStr = date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        
                        const quantityText = data.type === 'crepes' 
                            ? `+${data.quantity} cr√™pes`
                            : `${data.type}: ${data.quantity || 'N/A'}`;
                        
                        historyHTML += `
                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <strong style="color: #28a745; font-size: 1.1rem;">${quantityText}</strong>
                                        <div style="font-size: 0.9rem; color: #666;">par ${data.adminName || 'Admin'} (${data.program === 'bachelor' ? 'Bachelor' : 'Master'})</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.9rem; color: #666;">${dateStr}</div>
                                        ${data.previousStock !== undefined ? `<div style="font-size: 0.8rem; color: #999;">Stock: ${data.previousStock} ‚Üí ${data.newStock}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    historyHTML += `</div>`;
                    restockHistoryDiv.innerHTML = historyHTML;
                    return;
                }
                
                if (historySnapshot.empty) {
                    restockHistoryDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Aucun restock effectu√© pour le moment (${program === 'bachelor' ? 'Bachelor' : 'Master'})
                        </div>
                    `;
                    return;
                }
                
                let historyHTML = `
                    <div style="display: grid; gap: 10px;">
                `;
                
                historySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp?.toDate ? data.timestamp.toDate() : 
                               (data.timestamp?.getTime ? new Date(data.timestamp) : 
                               new Date(data.timestamp || new Date()));
                    const dateStr = date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    let quantityText = '';
                    if (data.type === 'reset') {
                        quantityText = 'üîÑ Reset';
                    } else if (data.type === 'filling') {
                        quantityText = `${getProductName ? getProductName(data.productType) : data.productType}: ${data.quantity === 'unlimited' ? '‚àû' : data.quantity}`;
                    } else if (data.type === 'snack') {
                        const change = data.quantity >= 0 ? `+${data.quantity}` : `${data.quantity}`;
                        quantityText = `üç™ ${data.productName || data.productId}: ${change}`;
                    } else {
                        quantityText = `+${data.quantity || 0} cr√™pes`;
                    }
                    
                    historyHTML += `
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <strong style="color: #28a745; font-size: 1.1rem;">${quantityText}</strong>
                                    <div style="font-size: 0.9rem; color: #666;">par ${data.adminName || 'Admin'} (${data.program === 'bachelor' ? 'Bachelor' : 'Master'})</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.9rem; color: #666;">${dateStr}</div>
                                    ${data.previousStock !== undefined ? `<div style="font-size: 0.8rem; color: #999;">Stock: ${data.previousStock} ‚Üí ${data.newStock}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                historyHTML += `</div>`;
                restockHistoryDiv.innerHTML = historyHTML;
                
            } catch (error) {
                console.error('Erreur lors du chargement de l\'historique:', error);
                if (restockHistoryDiv) {
                    const errorMessage = error.message || error.toString() || 'Erreur inconnue';
                    restockHistoryDiv.innerHTML = `
                        <div class="error">Erreur lors du chargement de l'historique: ${errorMessage}<br>
                        <small style="color: #999;">V√©rifiez la console pour plus de d√©tails</small></div>
                    `;
                }
            }
        }

        // Fonction pour v√©rifier le stock avant commande
        async function checkStock() {
            try {
                const program = getCurrentProgram();
                const stockDoc = await db.collection('stock').doc(program).get();
                if (stockDoc.exists) {
                    return stockDoc.data().quantity || 0;
                }
                return 0;
            } catch (error) {
                console.error('Erreur lors de la v√©rification du stock:', error);
                return 0;
            }
        }

        // Fonction pour activer/d√©sactiver les champs de limitation
        function toggleLimit(type) {
            const checkbox = document.getElementById(`limit${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const input = document.getElementById(`limit${type.charAt(0).toUpperCase() + type.slice(1)}Qty`);
            
            if (checkbox.checked) {
                input.disabled = false;
                input.focus();
            } else {
                input.disabled = true;
                input.value = '';
            }
        }

        // Fonction pour mettre √† jour l'affichage du stock
        function updateStockDisplay() {
            const program = getCurrentProgram();
            
            // Afficher le programme actuel dans l'indicateur
            const programIndicator = document.getElementById('stock-program-indicator');
            if (programIndicator) {
                programIndicator.textContent = `(${program === 'bachelor' ? 'Bachelor' : 'Master'})`;
            }
            
            // Afficher les status des fillings
            document.getElementById('stockSucreDisplay').textContent = fillingStatus['crepes-sucre'] === 'unlimited' ? '‚àû' : fillingStatus['crepes-sucre'];
            document.getElementById('stockNutellaDisplay').textContent = fillingStatus['crepes-nutella'] === 'unlimited' ? '‚àû' : fillingStatus['crepes-nutella'];
            document.getElementById('stockConfitureDisplay').textContent = fillingStatus['crepes-confiture'] === 'unlimited' ? '‚àû' : fillingStatus['crepes-confiture'];
            
            // Afficher le stock global
            document.getElementById('totalStockDisplay').textContent = currentStock;
            
            // Mettre √† jour l'affichage des fillings
            updateFillingDisplay();
        }

        // Fonction pour mettre √† jour l'affichage des fillings
        function updateFillingDisplay() {
            document.getElementById('fillingSucreDisplay').textContent = fillingStatus['crepes-sucre'] === 'unlimited' ? '‚àû' : fillingStatus['crepes-sucre'];
            document.getElementById('fillingNutellaDisplay').textContent = fillingStatus['crepes-nutella'] === 'unlimited' ? '‚àû' : fillingStatus['crepes-nutella'];
            document.getElementById('fillingConfitureDisplay').textContent = fillingStatus['crepes-confiture'] === 'unlimited' ? '‚àû' : fillingStatus['crepes-confiture'];
            
            // Mettre √† jour les checkboxes
            document.getElementById('unlimitedSucre').checked = fillingStatus['crepes-sucre'] === 'unlimited';
            document.getElementById('unlimitedNutella').checked = fillingStatus['crepes-nutella'] === 'unlimited';
            document.getElementById('unlimitedConfiture').checked = fillingStatus['crepes-confiture'] === 'unlimited';
        }

        // Fonction pour mettre √† jour un filling
        async function updateFilling(productType, inputId) {
            const quantity = parseInt(document.getElementById(inputId).value);
            
            if (!quantity || quantity <= 0) {
                showMessage('Veuillez entrer une quantit√© valide', 'error');
                return;
            }
            
            try {
                const program = getCurrentProgram();
                
                // Mettre √† jour le status du filling
                fillingStatus[productType] = quantity;
                
                // Sauvegarder en base pour le programme actuel
                await db.collection('fillingStatus').doc(program).set({
                    ...fillingStatus,
                    lastUpdated: new Date(),
                    program: program
                });
                
                // Enregistrer l'historique avec le programme
                await db.collection('restockHistory').add({
                    type: 'filling',
                    productType: productType,
                    quantity: quantity,
                    program: program,
                    adminId: currentUser.uid,
                    adminName: currentUser.firstName + ' ' + currentUser.lastName,
                    timestamp: new Date()
                });
                
                // Mettre √† jour l'affichage
                updateStockDisplay();
                document.getElementById(inputId).value = '';
                
                const productName = getProductName(productType);
                showMessage(`${productName} : ${quantity} disponibles`, 'success');
                
                // Recharger l'historique
                loadRestockHistory();
                
                // Recharger l'√©tat des boutons de commande
                setTimeout(checkStockOnLoad, 500);
                
            } catch (error) {
                console.error('Erreur lors de la mise √† jour du filling:', error);
                showMessage('Erreur lors de la mise √† jour du filling: ' + error.message, 'error');
            }
        }

        // Fonction pour basculer le filling en illimit√©
        async function toggleFillingUnlimited(productType, checkboxId) {
            const checkbox = document.getElementById(checkboxId);
            const isUnlimited = checkbox.checked;
            
            try {
                const program = getCurrentProgram();
                
                if (isUnlimited) {
                    fillingStatus[productType] = 'unlimited';
                } else {
                    // Demander une quantit√©
                    const quantity = prompt(`Entrez la quantit√© pour ${getProductName(productType)} :`);
                    if (!quantity || quantity <= 0) {
                        checkbox.checked = false;
                        return;
                    }
                    fillingStatus[productType] = parseInt(quantity);
                }
                
                // Sauvegarder en base pour le programme actuel
                await db.collection('fillingStatus').doc(program).set({
                    ...fillingStatus,
                    lastUpdated: new Date(),
                    program: program
                });
                
                // Enregistrer l'historique avec le programme
                await db.collection('restockHistory').add({
                    type: 'filling',
                    productType: productType,
                    quantity: isUnlimited ? 'unlimited' : fillingStatus[productType],
                    program: program,
                    adminId: currentUser.uid,
                    adminName: currentUser.firstName + ' ' + currentUser.lastName,
                    timestamp: new Date()
                });
                
                // Mettre √† jour l'affichage
                updateStockDisplay();
                
                const productName = getProductName(productType);
                const message = isUnlimited ? 
                    `${productName} : Illimit√©` : 
                    `${productName} : ${fillingStatus[productType]} disponibles`;
                showMessage(message, 'success');
                
                // Recharger l'historique
                loadRestockHistory();
                
                // Recharger l'√©tat des boutons de commande
                setTimeout(checkStockOnLoad, 500);
                
            } catch (error) {
                console.error('Erreur lors de la modification du filling:', error);
                showMessage('Erreur lors de la modification du filling: ' + error.message, 'error');
                checkbox.checked = !isUnlimited; // Annuler le changement
            }
        }

        // Fonction pour v√©rifier si une commande est possible (stock + filling)
        async function canOrderProduct(productType) {
            try {
                const program = getCurrentProgram();
                
                // V√©rifier le stock global pour le programme actuel
                const stockDoc = await db.collection('stock').doc(program).get();
                if (!stockDoc.exists) return false;
                
                const globalStock = stockDoc.data().quantity || 0;
                if (globalStock <= 0) return false;
                
                // V√©rifier le status du filling pour le programme actuel
                const fillingDoc = await db.collection('fillingStatus').doc(program).get();
                if (!fillingDoc.exists) return true; // Pas de status = OK
                
                const data = fillingDoc.data();
                const fillingStatus = data[productType];
                
                // Si illimit√©, OK tant qu'il y a du stock global
                if (fillingStatus === 'unlimited') return true;
                
                // Si limit√©, v√©rifier qu'il reste du filling
                return fillingStatus > 0;
                
            } catch (error) {
                console.error('Erreur lors de la v√©rification du stock:', error);
                return false;
            }
        }

        // Fonction pour reset tout le stock
        async function resetAllStock() {
            const program = getCurrentProgram();
            if (!confirm(`‚ö†Ô∏è √ätes-vous s√ªr de vouloir remettre √† z√©ro le stock ${program === 'bachelor' ? 'Bachelor' : 'Master'} ?\n\nCette action est irr√©versible et effacera tous les stocks actuels pour ce programme.`)) {
                return;
            }

            try {
                // Reset stock global pour le programme actuel
                await db.collection('stock').doc(program).set({
                    quantity: 0,
                    lastUpdated: new Date(),
                    program: program
                });

                // Reset fillings pour le programme actuel
                await db.collection('fillingStatus').doc(program).set({
                    'crepes-sucre': 'unlimited',
                    'crepes-nutella': 'unlimited',
                    'crepes-confiture': 'unlimited',
                    lastUpdated: new Date(),
                    program: program
                });

                // Enregistrer l'historique du reset avec le programme
                await db.collection('restockHistory').add({
                    type: 'reset',
                    program: program,
                    adminId: currentUser.uid,
                    adminName: currentUser.firstName + ' ' + currentUser.lastName,
                    timestamp: new Date()
                });

                // Mettre √† jour les variables locales
                currentStock = 0;
                fillingStatus = {
                    'crepes-sucre': 'unlimited',
                    'crepes-nutella': 'unlimited',
                    'crepes-confiture': 'unlimited'
                };

                // Mettre √† jour l'affichage
                updateStockDisplay();

                showMessage('üîÑ Stock remis √† z√©ro avec succ√®s !', 'success');

                // Recharger l'historique
                loadRestockHistory();

                // Recharger l'√©tat des boutons de commande
                setTimeout(checkStockOnLoad, 500);

            } catch (error) {
                console.error('Erreur lors du reset du stock:', error);
                showMessage('Erreur lors du reset du stock: ' + error.message, 'error');
            }
        }

        // Variables globales pour la s√©lection multiple
        let selectedOrders = new Set();
        let currentFilteredOrders = [];

        // Fonctions pour la s√©lection multiple
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.order-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                if (selectAllCheckbox.checked) {
                    selectedOrders.add(checkbox.dataset.orderId);
                } else {
                    selectedOrders.delete(checkbox.dataset.orderId);
                }
            });
            
            updateBulkActions();
        }

        function selectAllVisible() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedOrders.add(checkbox.dataset.orderId);
            });
            document.getElementById('selectAllCheckbox').checked = true;
            updateBulkActions();
        }

        function deselectAll() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllCheckbox').checked = false;
            selectedOrders.clear();
            updateBulkActions();
        }

        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            selectedOrders.clear();
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedOrders.add(checkbox.dataset.orderId);
                }
            });
            
            const selectedCount = selectedOrders.size;
            const bulkActions = document.getElementById('bulkActions');
            const selectedCountSpan = document.getElementById('selectedCount');
            
            if (selectedCount > 0) {
                bulkActions.style.display = 'block';
                selectedCountSpan.textContent = `${selectedCount} commande(s) s√©lectionn√©e(s)`;
            } else {
                bulkActions.style.display = 'none';
            }
        }

        // Actions en lot
        async function markSelectedAsDelivered() {
            if (selectedOrders.size === 0) {
                showMessage('Aucune commande s√©lectionn√©e', 'error');
                return;
            }

            if (!confirm(`Marquer ${selectedOrders.size} commande(s) comme livr√©es ?`)) {
                return;
            }

            try {
                const batch = db.batch();
                selectedOrders.forEach(orderId => {
                    const orderRef = db.collection('orders').doc(orderId);
                    batch.update(orderRef, { status: 'delivered' });
                });
                
                await batch.commit();
                
                showMessage(`${selectedOrders.size} commande(s) marqu√©e(s) comme livr√©es`, 'success');
                selectedOrders.clear();
                deselectAll();
                
                // Recharger les commandes
                const statusFilter = document.getElementById('statusFilter').value;
                const productFilter = document.getElementById('productFilter').value;
                const classFilter = document.getElementById('classFilter').value;
                const sortFilter = document.getElementById('sortFilter').value;
                loadAllOrdersWithFilters(statusFilter, productFilter, classFilter, sortFilter);
                
            } catch (error) {
                console.error('Erreur lors de la mise √† jour:', error);
                showMessage('Erreur lors de la mise √† jour: ' + error.message, 'error');
            }
        }

        async function deleteSelected() {
            if (selectedOrders.size === 0) {
                showMessage('Aucune commande s√©lectionn√©e', 'error');
                return;
            }

            if (!confirm(`Supprimer D√âFINITIVEMENT ${selectedOrders.size} commande(s) ?\n\nCette action est irr√©versible !`)) {
                return;
            }

            try {
                const batch = db.batch();
                selectedOrders.forEach(orderId => {
                    const orderRef = db.collection('orders').doc(orderId);
                    batch.delete(orderRef);
                });
                
                await batch.commit();
                
                showMessage(`${selectedOrders.size} commande(s) supprim√©e(s)`, 'success');
                selectedOrders.clear();
                deselectAll();
                
                // Recharger les commandes
                const statusFilter = document.getElementById('statusFilter').value;
                const productFilter = document.getElementById('productFilter').value;
                const classFilter = document.getElementById('classFilter').value;
                const sortFilter = document.getElementById('sortFilter').value;
                loadAllOrdersWithFilters(statusFilter, productFilter, classFilter, sortFilter);
                
            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                showMessage('Erreur lors de la suppression: ' + error.message, 'error');
            }
        }

        async function deleteAllFiltered() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            const totalVisible = checkboxes.length;
            
            if (totalVisible === 0) {
                showMessage('Aucune commande visible √† supprimer', 'error');
                return;
            }

            if (!confirm(`Supprimer D√âFINITIVEMENT TOUTES les ${totalVisible} commande(s) visibles (filtr√©es) ?\n\nCette action est irr√©versible !`)) {
                return;
            }

            try {
                const batch = db.batch();
                checkboxes.forEach(checkbox => {
                    const orderRef = db.collection('orders').doc(checkbox.dataset.orderId);
                    batch.delete(orderRef);
                });
                
                await batch.commit();
                
                showMessage(`${totalVisible} commande(s) supprim√©e(s)`, 'success');
                selectedOrders.clear();
                deselectAll();
                
                // Recharger les commandes
                const statusFilter = document.getElementById('statusFilter').value;
                const productFilter = document.getElementById('productFilter').value;
                const classFilter = document.getElementById('classFilter').value;
                const sortFilter = document.getElementById('sortFilter').value;
                loadAllOrdersWithFilters(statusFilter, productFilter, classFilter, sortFilter);
                
            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                showMessage('Erreur lors de la suppression: ' + error.message, 'error');
            }
        }
        // ========== CLASS MANAGEMENT FUNCTIONS ==========
        
        // Supprimer toutes les classes de la veille (nettoyage automatique √† la fin de la journ√©e)
        async function cleanupOldClasses() {
            try {
                const now = new Date();
                // Cr√©er une date pour aujourd'hui √† minuit (00:00:00)
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0]; // Format YYYY-MM-DD
                
                // R√©cup√©rer toutes les classes
                const allClassesSnapshot = await db.collection('classes').get();
                
                const deletePromises = [];
                const updatePromises = [];
                
                allClassesSnapshot.forEach(doc => {
                    const classData = doc.data();
                    let shouldDelete = false;
                    
                    // V√©rifier d'abord le champ date (priorit√©)
                    if (classData.date) {
                        // Si date n'est pas aujourd'hui, supprimer
                        if (classData.date !== todayStr) {
                            shouldDelete = true;
                            console.log(`Nettoyage: Classe ${classData.room} supprim√©e (date=${classData.date}, aujourd'hui=${todayStr})`);
                        }
                    } else if (classData.createdAt) {
                        // Sinon utiliser createdAt
                        const createdDate = classData.createdAt.toDate ? classData.createdAt.toDate() : new Date(classData.createdAt);
                        const createdDay = new Date(createdDate.getFullYear(), createdDate.getMonth(), createdDate.getDate());
                        createdDay.setHours(0, 0, 0, 0);
                        // Si createdAt est strictement avant aujourd'hui, supprimer
                        if (createdDay.getTime() < today.getTime()) {
                            shouldDelete = true;
                            console.log(`Nettoyage: Classe ${classData.room} supprim√©e (createdAt=${createdDate.toISOString()})`);
                        }
                    } else {
                        // Si pas de date ni createdAt, supprimer (anciennes classes sans date)
                        shouldDelete = true;
                        console.log(`Nettoyage: Classe ${classData.room} supprim√©e (pas de date ni createdAt)`);
                    }
                    
                    // V√©rifier aussi les horaires individuels - supprimer les schedules expir√©s
                    if (!shouldDelete && classData.schedules && Array.isArray(classData.schedules)) {
                        const validSchedules = [];
                        classData.schedules.forEach(schedule => {
                            if (schedule.createdAt) {
                                const scheduleDate = schedule.createdAt.toDate ? schedule.createdAt.toDate() : new Date(schedule.createdAt);
                                const scheduleDay = new Date(scheduleDate.getFullYear(), scheduleDate.getMonth(), scheduleDate.getDate());
                                scheduleDay.setHours(0, 0, 0, 0);
                                // Garder seulement les schedules d'aujourd'hui
                                if (scheduleDay.getTime() === today.getTime()) {
                                    validSchedules.push(schedule);
                                } else {
                                    console.log(`Nettoyage: Schedule ${schedule.startTime}-${schedule.endTime} supprim√© (pas d'aujourd'hui)`);
                                }
                            } else {
                                // Si pas de createdAt sur le schedule, le supprimer (trop ancien)
                                console.log(`Nettoyage: Schedule ${schedule.startTime}-${schedule.endTime} supprim√© (pas de createdAt)`);
                            }
                        });
                        
                        // Si tous les schedules sont expir√©s, supprimer la classe
                        if (validSchedules.length === 0) {
                            shouldDelete = true;
                            console.log(`Nettoyage: Classe ${classData.room} supprim√©e (aucun schedule valide)`);
                        } else if (validSchedules.length < classData.schedules.length) {
                            // Mettre √† jour la classe avec seulement les schedules valides
                            updatePromises.push(db.collection('classes').doc(doc.id).update({
                                schedules: validSchedules
                            }));
                            console.log(`Nettoyage: Classe ${classData.room} mise √† jour (${validSchedules.length}/${classData.schedules.length} schedules conserv√©s)`);
                        }
                    }
                    
                    if (shouldDelete) {
                        deletePromises.push(db.collection('classes').doc(doc.id).delete());
                    }
                });
                
                if (updatePromises.length > 0) {
                    await Promise.all(updatePromises);
                    console.log(`${updatePromises.length} classe(s) mise(s) √† jour (nettoyage automatique)`);
                }
                
                if (deletePromises.length > 0) {
                    await Promise.all(deletePromises);
                    console.log(`${deletePromises.length} salle(s) supprim√©e(s) (nettoyage automatique)`);
                }
            } catch (error) {
                console.error('Erreur lors du nettoyage des salles:', error);
            }
        }
        
        // Load classes from Firebase
        async function loadClasses() {
            // Nettoyer les anciennes classes avant de charger
            await cleanupOldClasses();
            try {
                // Charger TOUTES les classes (Bachelor et Master)
                const classesSnapshot = await db.collection('classes').get();
                
                // Date d'aujourd'hui √† minuit pour comparer
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0]; // Format YYYY-MM-DD
                
                console.log('Date d\'aujourd\'hui pour filtrage:', todayStr);
                
                allClasses = [];
                classesSnapshot.forEach(doc => {
                    const classData = { id: doc.id, ...doc.data() };
                    
                    // V√©rifier si la classe est d'aujourd'hui - STRICT: doit avoir date ou createdAt d'aujourd'hui
                    let isToday = false;
                    
                    // Utiliser le champ date si disponible (format YYYY-MM-DD)
                    if (classData.date) {
                        isToday = classData.date === todayStr;
                        console.log(`Classe ${classData.room}: date=${classData.date}, isToday=${isToday}`);
                    } else if (classData.createdAt) {
                        // Sinon utiliser createdAt
                        const createdDate = classData.createdAt.toDate ? classData.createdAt.toDate() : new Date(classData.createdAt);
                        const createdDay = new Date(createdDate.getFullYear(), createdDate.getMonth(), createdDate.getDate());
                        createdDay.setHours(0, 0, 0, 0);
                        isToday = createdDay.getTime() === today.getTime();
                        console.log(`Classe ${classData.room}: createdAt=${createdDate.toISOString()}, isToday=${isToday}`);
                    } else {
                        // Si pas de date ni createdAt, on ignore la classe (trop ancienne)
                        console.log(`Classe ${classData.room}: pas de date ni createdAt, ignor√©e`);
                        return;
                    }
                    
                    // Si la classe n'est pas d'aujourd'hui, on l'ignore compl√®tement
                    if (!isToday) {
                        console.log(`Classe ${classData.room}: pas d'aujourd'hui, ignor√©e`);
                        return;
                    }
                    
                    // Filtrer les schedules pour ne garder QUE ceux d'aujourd'hui
                    if (classData.schedules && classData.schedules.length > 0) {
                        classData.schedules = classData.schedules.filter(schedule => {
                            if (schedule.createdAt) {
                                const scheduleDate = schedule.createdAt.toDate ? schedule.createdAt.toDate() : new Date(schedule.createdAt);
                                const scheduleDay = new Date(scheduleDate.getFullYear(), scheduleDate.getMonth(), scheduleDate.getDate());
                                scheduleDay.setHours(0, 0, 0, 0);
                                const isScheduleToday = scheduleDay.getTime() === today.getTime();
                                if (!isScheduleToday) {
                                    console.log(`Schedule ${schedule.startTime}-${schedule.endTime}: pas d'aujourd'hui, ignor√©`);
                                }
                                return isScheduleToday;
                            }
                            // Si pas de createdAt sur le schedule, on l'ignore (trop ancien)
                            console.log(`Schedule ${schedule.startTime}-${schedule.endTime}: pas de createdAt, ignor√©`);
                            return false;
                        });
                    }
                    
                    // Ne garder la classe que si elle a au moins un schedule d'aujourd'hui
                    if (classData.schedules && classData.schedules.length > 0) {
                        // Sort schedules by start time
                        classData.schedules.sort((a, b) => {
                            const timeA = a.startTime || '';
                            const timeB = b.startTime || '';
                            return timeA.localeCompare(timeB);
                        });
                        allClasses.push(classData);
                        console.log(`Classe ${classData.room}: ajout√©e avec ${classData.schedules.length} schedule(s) d'aujourd'hui`);
                    } else {
                        console.log(`Classe ${classData.room}: aucun schedule d'aujourd'hui, ignor√©e`);
                    }
                });
                
                console.log(`Total classes d'aujourd'hui: ${allClasses.length}`);
                
                // Sort classes by room number (natural sort - ordre croissant: 104, 156, 345-378, etc.)
                allClasses.sort((a, b) => {
                    const roomA = a.room || '';
                    const roomB = b.room || '';
                    // Extract numbers for comparison
                    const numA = parseInt(roomA.replace(/\D/g, '')) || 0;
                    const numB = parseInt(roomB.replace(/\D/g, '')) || 0;
                    if (numA !== numB) return numA - numB;
                    return roomA.localeCompare(roomB);
                });
                
                displayClasses();
            } catch (error) {
                console.error('Erreur lors du chargement des salles:', error);
                const classesList = document.getElementById('classes-list');
                if (classesList) {
                    classesList.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">Erreur lors du chargement des salles</p>';
                }
            }
        }
        
        // Display classes in the list (compact format - one line per schedule)
        function displayClasses(filter = '') {
            const classesList = document.getElementById('classes-list');
            if (!classesList) return;
            
            const searchTerm = filter.toLowerCase();
            
            const filteredClasses = allClasses.filter(cls => {
                if (!searchTerm) return true;
                return cls.room.toLowerCase().includes(searchTerm);
            });
            
            if (filteredClasses.length === 0) {
                classesList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Aucune classe trouv√©e</p>';
                return;
            }
            
            // Cr√©er une liste plate de tous les horaires avec leur classe
            const allSchedules = [];
            filteredClasses.forEach(cls => {
                if (cls.schedules && cls.schedules.length > 0) {
                    cls.schedules.forEach((schedule, idx) => {
                        allSchedules.push({
                            classId: cls.id,
                            scheduleIndex: idx,
                            room: cls.room,
                            startTime: schedule.startTime || '',
                            endTime: schedule.endTime || '',
                            schedule: schedule
                        });
                    });
                }
            });
            
            // Trier par salle puis par heure de d√©but
            allSchedules.sort((a, b) => {
                const roomA = a.room || '';
                const roomB = b.room || '';
                const numA = parseInt(roomA.replace(/\D/g, '')) || 0;
                const numB = parseInt(roomB.replace(/\D/g, '')) || 0;
                if (numA !== numB) return numA - numB;
                if (roomA !== roomB) return roomA.localeCompare(roomB);
                return (a.startTime || '').localeCompare(b.startTime || '');
            });
            
            if (allSchedules.length === 0) {
                classesList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Aucun horaire disponible</p>';
                return;
            }
            
            // Filtrer les classes expir√©es - ne garder que celles dont la deadline n'est pas pass√©e
            const now = new Date();
            const validSchedules = allSchedules.filter(item => {
                const deliveryTime = calculateDeliveryTime(item.startTime, item.endTime);
                const deadline = calculateDeadline(deliveryTime);
                const deadlineDate = new Date(deadline);
                return deadlineDate >= now;
            });
            
            if (validSchedules.length === 0) {
                classesList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Aucun horaire disponible (tous les horaires sont expir√©s)</p>';
                return;
            }
            
            // Afficher chaque horaire sur une ligne compacte (seulement les non-expir√©s)
            classesList.innerHTML = validSchedules.map(item => {
                const deliveryTime = calculateDeliveryTime(item.startTime, item.endTime);
                const deadline = calculateDeadline(deliveryTime);
                
                return `
                    <div class="schedule-line" 
                         onclick="selectClassSchedule('${item.classId}', ${item.scheduleIndex})"
                         style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; margin: 3px 0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s;"
                         onmouseover="this.style.background='#f0f4ff'"
                         onmouseout="this.style.background='white'">
                        <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                            <div style="font-weight: bold; color: #6c5ce7; min-width: 80px; font-size: 14px;">
                                üìö Salle ${item.room}
                            </div>
                            <div style="font-weight: 600; color: #333; min-width: 120px; font-size: 14px;">
                                ${item.startTime} - ${item.endTime}
                            </div>
                            <div style="font-size: 12px; color: #666; flex: 1;">
                                Livraison: ${formatTime(deliveryTime)} | Deadline: ${formatTime(deadline)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter classes
        function filterClasses() {
            const searchInput = document.getElementById('class-search');
            if (!searchInput) return;
            const searchTerm = searchInput.value;
            displayClasses(searchTerm);
        }
        
        // Show class selection
        function showClassSelection() {
            const selectionSection = document.getElementById('class-selection-section');
            const creationSection = document.getElementById('class-creation-section');
            const selectBtn = document.getElementById('select-class-btn');
            const createBtn = document.getElementById('create-class-btn');
            
            if (selectionSection) {
                selectionSection.style.display = 'block';
                selectionSection.style.visibility = 'visible';
            }
            if (creationSection) {
                creationSection.style.display = 'none';
                creationSection.style.visibility = 'hidden';
            }
            if (selectBtn) selectBtn.className = 'btn';
            if (createBtn) createBtn.className = 'btn btn-secondary';
            
            // Charger les classes avec un petit d√©lai pour s'assurer que la section est visible
            setTimeout(() => {
                loadClasses();
            }, 100);
        }
        
        // Show class creation
        function showClassCreation() {
            const selectionSection = document.getElementById('class-selection-section');
            const creationSection = document.getElementById('class-creation-section');
            const selectBtn = document.getElementById('select-class-btn');
            const createBtn = document.getElementById('create-class-btn');
            
            if (selectionSection) {
                selectionSection.style.display = 'none';
                selectionSection.style.visibility = 'hidden';
            }
            if (creationSection) {
                creationSection.style.display = 'block';
                creationSection.style.visibility = 'visible';
            }
            if (selectBtn) selectBtn.className = 'btn btn-secondary';
            if (createBtn) createBtn.className = 'btn';
        }
        
        // Select class schedule
        function selectClassSchedule(classId, scheduleIndex) {
            const classData = allClasses.find(c => c.id === classId);
            if (!classData || !classData.schedules || !classData.schedules[scheduleIndex]) {
                alert('Erreur: classe ou horaire introuvable');
                return;
            }
            
            const schedule = classData.schedules[scheduleIndex];
            const startTime = schedule.startTime || '';
            const endTime = schedule.endTime || '';
            const deliveryTime = calculateDeliveryTime(startTime, endTime);
            const deadline = calculateDeadline(deliveryTime);
            
            // Check if deadline has passed
            const now = new Date();
            const deadlineDate = new Date(deadline);
            if (deadlineDate < now) {
                alert('‚ö†Ô∏è La deadline de commande pour cet horaire est pass√©e. Veuillez s√©lectionner un autre horaire.');
                return;
            }
            
            // Save selection
            document.getElementById('selected-class-id').value = classId;
            document.getElementById('selected-class-schedule-id').value = scheduleIndex;
            
            // Display selected class info
            document.getElementById('selected-class-name').textContent = `Salle ${classData.room}`;
            document.getElementById('selected-class-time').textContent = `${startTime} - ${endTime}`;
            document.getElementById('selected-delivery-time').textContent = formatTime(deliveryTime);
            document.getElementById('selected-deadline-time').textContent = formatTime(deadline);
            document.getElementById('selected-class-info').style.display = 'block';
            
            // Enable order button
            document.getElementById('modal-confirm-btn').disabled = false;
            
            // Update deadline warning
            updateDeadlineWarning(deadline);
        }
        
        // Create new class
        async function createNewClass() {
            const roomInput = document.getElementById('new-class-room').value.trim();
            const startTime = document.getElementById('new-class-start').value;
            const endTime = document.getElementById('new-class-end').value;
            const userProgram = currentUser?.program || getCurrentProgram();
            
            if (!roomInput || !startTime || !endTime) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            if (startTime >= endTime) {
                alert('L\'heure de fin doit √™tre apr√®s l\'heure de d√©but');
                return;
            }
            
            // Utiliser le nom de la salle tel quel (sans suffixe)
            const room = roomInput;
            
            try {
                // Nettoyer les anciennes classes avant de v√©rifier les doublons
                await cleanupOldClasses();
                
                // Check if class with same room already exists (sans filtre par programme)
                const existingClasses = await db.collection('classes').where('room', '==', room).get();
                
                if (!existingClasses.empty) {
                    // Class exists, add schedule to it
                    const existingClass = existingClasses.docs[0];
                    const classData = existingClass.data();
                    const schedules = classData.schedules || [];
                    
                    // Check if schedule already exists
                    const scheduleExists = schedules.some(s => s.startTime === startTime && s.endTime === endTime);
                    if (scheduleExists) {
                        alert('Cet horaire existe d√©j√† pour cette classe');
                        return;
                    }
                    
                    // Add new schedule avec date d'aujourd'hui
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    schedules.push({
                        startTime,
                        endTime,
                        createdAt: today.toISOString()
                    });
                    
                    await db.collection('classes').doc(existingClass.id).update({
                        schedules
                    });
                    
                    alert('Horaire ajout√© √† la salle existante !');
                } else {
                    // Create new class
                    // Date d'aujourd'hui (juste le jour, sans l'heure)
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const newClass = {
                        room, // Le nom de la salle (sans suffixe)
                        schedules: [{
                            startTime,
                            endTime,
                            createdAt: today.toISOString()
                        }],
                        createdAt: today.toISOString(),
                        date: today.toISOString().split('T')[0] // Format YYYY-MM-DD pour faciliter le filtrage
                    };
                    
                    await db.collection('classes').add(newClass);
                    alert('Classe cr√©√©e avec succ√®s !');
                }
                
                // Reset form and reload classes
                document.getElementById('new-class-room').value = '';
                document.getElementById('new-class-start').value = '';
                document.getElementById('new-class-end').value = '';
                showClassSelection();
                loadClasses();
            } catch (error) {
                console.error('Erreur lors de la cr√©ation de la classe:', error);
                alert('Erreur lors de la cr√©ation de la classe');
            }
        }
        
        // Calculate delivery time (middle of class)
        function calculateDeliveryTime(startTime, endTime) {
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            const now = new Date();
            const startDate = new Date(now);
            startDate.setHours(startHour, startMin, 0, 0);
            
            const endDate = new Date(now);
            endDate.setHours(endHour, endMin, 0, 0);
            
            // Si l'heure de fin est avant l'heure de d√©but (ex: 22:30 - 23:30), 
            // cela signifie que c'est le m√™me jour, donc pas besoin d'ajouter un jour
            // Mais si endHour < startHour (ex: 23:00 - 01:00), alors on ajoute un jour √† endDate
            if (endHour < startHour || (endHour === startHour && endMin < startMin)) {
                endDate.setDate(endDate.getDate() + 1);
            }
            
            // Middle time
            const middleTime = new Date((startDate.getTime() + endDate.getTime()) / 2);
            
            return middleTime;
        }
        
        // Calculate deadline (5 minutes before delivery)
        function calculateDeadline(deliveryTime) {
            const deadline = new Date(deliveryTime);
            deadline.setMinutes(deadline.getMinutes() - 5);
            return deadline;
        }
        
        // Format time to HH:MM
        function formatTime(date) {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Load all classes for the classes tab
        async function loadAllClasses() {
            try {
                // Recharger les classes avec loadClasses() pour avoir les donn√©es √† jour
                await loadClasses();
                
                // Cr√©er une liste plate de tous les horaires avec leur classe (comme dans displayClasses)
                const allSchedules = [];
                allClasses.forEach(cls => {
                    if (cls.schedules && cls.schedules.length > 0) {
                        cls.schedules.forEach((schedule, idx) => {
                            const startTime = schedule.startTime || '';
                            const endTime = schedule.endTime || '';
                            if (startTime && endTime) {
                                const deliveryTime = calculateDeliveryTime(startTime, endTime);
                                allSchedules.push({
                                    classId: cls.id,
                                    scheduleIndex: idx,
                                    room: cls.room || '',
                                    startTime: startTime,
                                    endTime: endTime,
                                    deliveryTime: deliveryTime
                                });
                            }
                        });
                    }
                });
                
                // Trier par num√©ro de salle (ordre croissant), puis par heure de d√©but
                allSchedules.sort((a, b) => {
                    // Extraire le num√©ro de la salle
                    const numA = parseInt(a.room.replace(/\D/g, '')) || 0;
                    const numB = parseInt(b.room.replace(/\D/g, '')) || 0;
                    
                    if (numA !== numB) {
                        return numA - numB; // Ordre croissant: 1 en haut, 900 en bas
                    }
                    
                    // Si m√™me salle, trier par heure de d√©but
                    return a.startTime.localeCompare(b.startTime);
                });
                
                // Afficher les classes
                const classesListDiv = document.getElementById('classesList');
                if (allSchedules.length === 0) {
                    classesListDiv.innerHTML = '<div class="error">Aucune classe trouv√©e pour aujourd\'hui</div>';
                    return;
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
                html += '<thead><tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">';
                html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Salle</th>';
                html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Heure d√©but</th>';
                html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Heure fin</th>';
                html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Heure livraison</th>';
                html += '</tr></thead><tbody>';
                
                allSchedules.forEach((classItem, index) => {
                    const rowColor = index % 2 === 0 ? '#fff' : '#f8f9fa';
                    html += `<tr style="background: ${rowColor}; border-bottom: 1px solid #e1e5e9;">`;
                    html += `<td style="padding: 12px;">${classItem.room}</td>`;
                    html += `<td style="padding: 12px;">${classItem.startTime}</td>`;
                    html += `<td style="padding: 12px;">${classItem.endTime}</td>`;
                    html += `<td style="padding: 12px; font-weight: 600; color: #28a745;">${formatTime(classItem.deliveryTime)}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                classesListDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Erreur lors du chargement des classes:', error);
                document.getElementById('classesList').innerHTML = `
                    <div class="error">Erreur lors du chargement des classes: ${error.message}</div>
                `;
            }
        }
        
        // Update deadline warning
        function updateDeadlineWarning(deadline) {
            // Annuler le timer pr√©c√©dent s'il existe
            if (deadlineTimer) {
                clearTimeout(deadlineTimer);
                deadlineTimer = null;
            }
            
            const warningDiv = document.getElementById('order-deadline-warning');
            const countdownSpan = document.getElementById('deadline-countdown');
            if (!warningDiv || !countdownSpan) return;
            
            const now = new Date();
            const deadlineDate = new Date(deadline);
            
            if (deadlineDate < now) {
                warningDiv.style.display = 'none';
                document.getElementById('modal-confirm-btn').disabled = true;
                return;
            }
            
            const diff = deadlineDate - now;
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            if (minutes > 0) {
                countdownSpan.textContent = `${minutes} min ${seconds} sec`;
            } else {
                countdownSpan.textContent = `${seconds} sec`;
            }
            
            warningDiv.style.display = 'block';
            
            // Update every second - stocker le timer ID
            deadlineTimer = setTimeout(() => updateDeadlineWarning(deadline), 1000);
        }
        
        // Stop deadline warning timer
        function stopDeadlineWarning() {
            if (deadlineTimer) {
                clearTimeout(deadlineTimer);
                deadlineTimer = null;
            }
            const warningDiv = document.getElementById('order-deadline-warning');
            if (warningDiv) {
                warningDiv.style.display = 'none';
            }
        }
        
        // ========== GESTION DES FILLINGS ET SNACKS PERSONNALIS√âS ==========
        
        // Charger les fillings personnalis√©s depuis Firebase
        async function loadCustomFillings() {
            try {
                const fillingsSnapshot = await db.collection('customFillings').orderBy('order', 'asc').get();
                customFillings = [];
                fillingsSnapshot.forEach(doc => {
                    customFillings.push({ id: doc.id, ...doc.data() });
                });
                
                // Si aucun filling n'existe, cr√©er les fillings par d√©faut
                if (customFillings.length === 0) {
                    const defaultFillings = [
                        { name: 'Cr√™pes Sucre', emoji: 'ü•û', description: 'Cr√™pes avec sucre et beurre', productId: 'crepes-sucre', order: 1 },
                        { name: 'Cr√™pes Nutella', emoji: 'üç´', description: 'Cr√™pes avec Nutella', productId: 'crepes-nutella', order: 2 },
                        { name: 'Cr√™pes Confiture', emoji: 'üçì', description: 'Cr√™pes avec confiture', productId: 'crepes-confiture', order: 3 }
                    ];
                    
                    for (const filling of defaultFillings) {
                        const docRef = await db.collection('customFillings').add({
                            ...filling,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        });
                        customFillings.push({ id: docRef.id, ...filling });
                    }
                }
                
                displayFillings();
            } catch (error) {
                console.error('Erreur lors du chargement des fillings:', error);
                const fillingsList = document.getElementById('fillingsList');
                if (fillingsList) {
                    fillingsList.innerHTML = `
                        <div class="error">Erreur lors du chargement des fillings: ${error.message}</div>
                    `;
                }
            }
        }
        
        // Charger les snacks personnalis√©s depuis Firebase
        async function loadCustomSnacks() {
            try {
                const snacksSnapshot = await db.collection('customSnacks').orderBy('name', 'asc').get();
                customSnacks = [];
                snacksSnapshot.forEach(doc => {
                    customSnacks.push({ id: doc.id, ...doc.data() });
                });
                displaySnacks();
            } catch (error) {
                console.error('Erreur lors du chargement des snacks:', error);
                document.getElementById('snacksList').innerHTML = `
                    <div class="error">Erreur lors du chargement des snacks: ${error.message}</div>
                `;
            }
        }
        
        // Afficher la liste des fillings
        function displayFillings() {
            const fillingsList = document.getElementById('fillingsList');
            if (!fillingsList) return;
            
            if (customFillings.length === 0) {
                fillingsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666; background: #f8f9fa; border-radius: 8px;">
                        Aucun filling configur√©. Cliquez sur "Ajouter un Filling" pour commencer.
                    </div>
                `;
                return;
            }
            
            // Trier par ordre
            const sortedFillings = [...customFillings].sort((a, b) => (a.order || 999) - (b.order || 999));
            
            fillingsList.innerHTML = sortedFillings.map((filling, index) => `
                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e1e5e9; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 15px; flex: 1;">
                            <span style="font-size: 2.5rem; line-height: 1;">${filling.emoji || 'ü•û'}</span>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: #333; font-size: 1.3rem; font-weight: 600;">${filling.name || 'Sans nom'}</h4>
                                <p style="margin: 0 0 10px 0; color: #666; font-size: 0.95rem; line-height: 1.4;">${filling.description || 'Aucune description'}</p>
                                <div style="font-size: 0.85rem; color: #999; display: flex; gap: 15px; flex-wrap: wrap;">
                                    <span><strong>ID:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${filling.productId || 'N/A'}</code></span>
                                    <span><strong>Ordre:</strong> ${filling.order || index + 1}</span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-shrink: 0;">
                            <button onclick="editFilling('${filling.id}')" style="background: #007bff; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; white-space: nowrap; transition: all 0.2s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button onclick="deleteFilling('${filling.id}')" style="background: #dc3545; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; white-space: nowrap; transition: all 0.2s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Afficher la liste des snacks
        function displaySnacks() {
            const snacksList = document.getElementById('snacksList');
            if (!snacksList) return;
            
            if (customSnacks.length === 0) {
                snacksList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666; background: #f8f9fa; border-radius: 8px;">
                        Aucun snack configur√©. Cliquez sur "Ajouter un Snack" pour commencer.
                    </div>
                `;
                return;
            }
            
            snacksList.innerHTML = customSnacks.map(snack => `
                <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e1e5e9; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 15px; flex: 1;">
                            <span style="font-size: 2.5rem; line-height: 1;">${snack.emoji || 'üç™'}</span>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: #333; font-size: 1.3rem; font-weight: 600;">${snack.name || 'Sans nom'}</h4>
                                <p style="margin: 0 0 10px 0; color: #666; font-size: 0.95rem; line-height: 1.4;">${snack.description || 'Aucune description'}</p>
                                <div style="font-size: 0.85rem; color: #999; display: flex; gap: 15px; flex-wrap: wrap;">
                                    <span><strong>Prix:</strong> <span style="color: #28a745; font-weight: 600; font-size: 1rem;">${snack.price || 0}‚Ç¨</span></span>
                                    <span><strong>ID:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${snack.productId || 'N/A'}</code></span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-shrink: 0;">
                            <button onclick="editSnack('${snack.id}')" style="background: #007bff; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; white-space: nowrap; transition: all 0.2s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button onclick="deleteSnack('${snack.id}')" style="background: #dc3545; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; white-space: nowrap; transition: all 0.2s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Afficher le modal pour ajouter un filling
        function showAddFillingModal() {
            if (customFillings.length >= 9) {
                showMessage('‚ùå Maximum 9 fillings autoris√©s !', 'error');
                return;
            }
            
            document.getElementById('fillingModalTitle').textContent = 'Ajouter un Filling';
            document.getElementById('fillingForm').reset();
            document.getElementById('fillingForm').setAttribute('data-filling-id', '');
            document.getElementById('fillingModal').style.display = 'flex';
        }
        
        // Afficher le modal pour modifier un filling
        async function editFilling(fillingId) {
            const filling = customFillings.find(f => f.id === fillingId);
            if (!filling) return;
            
            document.getElementById('fillingModalTitle').textContent = 'Modifier le Filling';
            document.getElementById('fillingName').value = filling.name || '';
            document.getElementById('fillingEmoji').value = filling.emoji || 'ü•û';
            document.getElementById('fillingDescription').value = filling.description || '';
            document.getElementById('fillingProductId').value = filling.productId || '';
            document.getElementById('fillingOrder').value = filling.order || customFillings.length + 1;
            document.getElementById('fillingForm').setAttribute('data-filling-id', fillingId);
            document.getElementById('fillingModal').style.display = 'flex';
        }
        
        // Sauvegarder un filling
        async function saveFilling() {
            const form = document.getElementById('fillingForm');
            const fillingId = form.getAttribute('data-filling-id');
            const name = document.getElementById('fillingName').value.trim();
            const emoji = document.getElementById('fillingEmoji').value.trim();
            const description = document.getElementById('fillingDescription').value.trim();
            const productId = document.getElementById('fillingProductId').value.trim();
            const order = parseInt(document.getElementById('fillingOrder').value) || customFillings.length + 1;
            
            if (!name || !emoji || !productId) {
                showMessage('‚ùå Veuillez remplir tous les champs obligatoires (nom, emoji, ID produit)', 'error');
                return;
            }
            
            // V√©rifier que l'ID produit n'existe pas d√©j√† (sauf si on modifie)
            if (!fillingId) {
                const existing = customFillings.find(f => f.productId === productId);
                if (existing) {
                    showMessage('‚ùå Cet ID produit existe d√©j√† !', 'error');
                    return;
                }
            }
            
            try {
                const fillingData = {
                    name,
                    emoji,
                    description,
                    productId,
                    order,
                    updatedAt: new Date()
                };
                
                if (fillingId) {
                    await db.collection('customFillings').doc(fillingId).update(fillingData);
                    showMessage('‚úÖ Filling modifi√© avec succ√®s !', 'success');
                } else {
                    fillingData.createdAt = new Date();
                    await db.collection('customFillings').add(fillingData);
                    showMessage('‚úÖ Filling ajout√© avec succ√®s !', 'success');
                }
                
                document.getElementById('fillingModal').style.display = 'none';
                await loadCustomFillings();
                // Recharger les produits dans la page de commande avec un petit d√©lai pour s'assurer que les donn√©es sont bien sauvegard√©es
                setTimeout(() => {
                    loadProductsForOrders();
                }, 300);
            } catch (error) {
                console.error('Erreur lors de la sauvegarde du filling:', error);
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Supprimer un filling
        async function deleteFilling(fillingId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce filling ?')) return;
            
            try {
                await db.collection('customFillings').doc(fillingId).delete();
                showMessage('‚úÖ Filling supprim√© avec succ√®s !', 'success');
                await loadCustomFillings();
                // Recharger les produits dans la page de commande
                loadProductsForOrders();
            } catch (error) {
                console.error('Erreur lors de la suppression du filling:', error);
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Afficher le modal pour ajouter un snack
        function showAddSnackModal() {
            document.getElementById('snackModalTitle').textContent = 'Ajouter un Snack';
            document.getElementById('snackForm').reset();
            document.getElementById('snackForm').setAttribute('data-snack-id', '');
            document.getElementById('snackModal').style.display = 'flex';
        }
        
        // Afficher le modal pour modifier un snack
        async function editSnack(snackId) {
            const snack = customSnacks.find(s => s.id === snackId);
            if (!snack) return;
            
            document.getElementById('snackModalTitle').textContent = 'Modifier le Snack';
            document.getElementById('snackName').value = snack.name || '';
            document.getElementById('snackEmoji').value = snack.emoji || 'üç™';
            document.getElementById('snackDescription').value = snack.description || '';
            document.getElementById('snackProductId').value = snack.productId || '';
            document.getElementById('snackPrice').value = snack.price || 0;
            document.getElementById('snackForm').setAttribute('data-snack-id', snackId);
            document.getElementById('snackModal').style.display = 'flex';
        }
        
        // Sauvegarder un snack
        async function saveSnack() {
            const form = document.getElementById('snackForm');
            const snackId = form.getAttribute('data-snack-id');
            const name = document.getElementById('snackName').value.trim();
            const emoji = document.getElementById('snackEmoji').value.trim();
            const description = document.getElementById('snackDescription').value.trim();
            const productId = document.getElementById('snackProductId').value.trim();
            const price = parseFloat(document.getElementById('snackPrice').value) || 0;
            
            if (!name || !emoji || !productId) {
                showMessage('‚ùå Veuillez remplir tous les champs obligatoires (nom, emoji, ID produit)', 'error');
                return;
            }
            
            // V√©rifier que l'ID produit n'existe pas d√©j√† (sauf si on modifie)
            if (!snackId) {
                const existing = customSnacks.find(s => s.productId === productId);
                if (existing) {
                    showMessage('‚ùå Cet ID produit existe d√©j√† !', 'error');
                    return;
                }
            }
            
            try {
                const snackData = {
                    name,
                    emoji,
                    description,
                    productId,
                    price,
                    updatedAt: new Date()
                };
                
                if (snackId) {
                    await db.collection('customSnacks').doc(snackId).update(snackData);
                    showMessage('‚úÖ Snack modifi√© avec succ√®s !', 'success');
                } else {
                    snackData.createdAt = new Date();
                    await db.collection('customSnacks').add(snackData);
                    showMessage('‚úÖ Snack ajout√© avec succ√®s !', 'success');
                }
                
                document.getElementById('snackModal').style.display = 'none';
                await loadCustomSnacks();
                // Recharger les produits dans la page de commande avec un petit d√©lai pour s'assurer que les donn√©es sont bien sauvegard√©es
                setTimeout(() => {
                    loadProductsForOrders();
                }, 300);
            } catch (error) {
                console.error('Erreur lors de la sauvegarde du snack:', error);
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Supprimer un snack
        async function deleteSnack(snackId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce snack ?')) return;
            
            try {
                await db.collection('customSnacks').doc(snackId).delete();
                showMessage('‚úÖ Snack supprim√© avec succ√®s !', 'success');
                await loadCustomSnacks();
                // Recharger les produits dans la page de commande avec un petit d√©lai
                setTimeout(() => {
                    loadProductsForOrders();
                }, 300);
            } catch (error) {
                console.error('Erreur lors de la suppression du snack:', error);
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Charger et afficher le stock des snacks dans l'onglet Restock
        async function loadSnacksStock() {
            try {
                const program = getCurrentProgram();
                const snacksStockManagement = document.getElementById('snacksStockManagement');
                if (!snacksStockManagement) return;
                
                // Charger les snacks personnalis√©s
                const snacksSnapshot = await db.collection('customSnacks').orderBy('name', 'asc').get();
                const snacks = [];
                snacksSnapshot.forEach(doc => {
                    snacks.push({ id: doc.id, ...doc.data() });
                });
                
                if (snacks.length === 0) {
                    snacksStockManagement.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666; background: #f8f9fa; border-radius: 8px; grid-column: 1 / -1;">
                            Aucun snack configur√©. Ajoutez des snacks dans l'onglet "Personnalisation".
                        </div>
                    `;
                    return;
                }
                
                // Charger le stock actuel des snacks
                const snackStockDoc = await db.collection('snackStock').doc(program).get();
                const snackStock = snackStockDoc.exists ? snackStockDoc.data() : {};
                
                // Afficher chaque snack avec son stock
                snacksStockManagement.innerHTML = snacks.map(snack => {
                    const currentStock = snackStock[snack.productId] || 0;
                    return `
                        <div style="padding: 15px; border: 1px solid #e1e5e9; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <span style="font-size: 1.5rem;">${snack.emoji || 'üç™'}</span>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0; color: #333;">${snack.name}</h4>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.85rem;">${snack.description || ''}</p>
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Stock actuel :</label>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #007bff;" id="snackStock_${snack.productId}">${currentStock}</div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: end;">
                                <div style="flex: 1;">
                                    <input type="number" id="snackQty_${snack.productId}" min="0" max="10000" placeholder="Quantit√©" 
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
                                </div>
                                <button onclick="updateSnackStock('${snack.productId}', '${snack.name}')" 
                                        style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                    Mettre √† jour
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erreur lors du chargement du stock des snacks:', error);
                const snacksStockManagement = document.getElementById('snacksStockManagement');
                if (snacksStockManagement) {
                    snacksStockManagement.innerHTML = `
                        <div class="error">Erreur lors du chargement: ${error.message}</div>
                    `;
                }
            }
        }
        
        // Mettre √† jour le stock d'un snack
        async function updateSnackStock(productId, snackName) {
            try {
                const program = getCurrentProgram();
                const qtyInput = document.getElementById(`snackQty_${productId}`);
                if (!qtyInput) return;
                
                const quantity = parseInt(qtyInput.value);
                if (isNaN(quantity) || quantity < 0) {
                    showMessage('‚ùå Veuillez entrer une quantit√© valide (‚â• 0)', 'error');
                    return;
                }
                
                // Charger le stock actuel
                const snackStockDoc = await db.collection('snackStock').doc(program).get();
                const snackStock = snackStockDoc.exists ? snackStockDoc.data() : {};
                const previousStock = snackStock[productId] || 0;
                
                // Mettre √† jour le stock
                snackStock[productId] = quantity;
                await db.collection('snackStock').doc(program).set({
                    ...snackStock,
                    program: program,
                    lastUpdated: new Date()
                });
                
                // Mettre √† jour l'affichage
                const stockDisplay = document.getElementById(`snackStock_${productId}`);
                if (stockDisplay) {
                    stockDisplay.textContent = quantity;
                }
                
                // Enregistrer dans l'historique
                const adminName = currentUser ? `${currentUser.firstName} ${currentUser.lastName}` : 'Admin';
                await db.collection('restockHistory').add({
                    type: 'snack',
                    productId: productId,
                    productName: snackName,
                    quantity: quantity - previousStock,
                    previousStock: previousStock,
                    newStock: quantity,
                    program: program,
                    adminName: adminName,
                    timestamp: new Date()
                });
                
                showMessage(`‚úÖ Stock de ${snackName} mis √† jour: ${previousStock} ‚Üí ${quantity}`, 'success');
                
                // Vider le champ
                qtyInput.value = '';
                
                // Recharger l'historique
                loadRestockHistory();
                
                // Recharger les produits dans la page de commande pour mettre √† jour l'affichage
                loadProductsForOrders();
                
            } catch (error) {
                console.error('Erreur lors de la mise √† jour du stock:', error);
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // R√©initialiser tous les snacks √† 0
        async function resetAllSnacksStock() {
            if (!confirm('√ätes-vous s√ªr de vouloir r√©initialiser le stock de TOUS les snacks √† 0 ?')) return;
            
            try {
                const program = getCurrentProgram();
                
                // Charger tous les snacks
                const snacksSnapshot = await db.collection('customSnacks').get();
                const snackStock = {};
                snacksSnapshot.forEach(doc => {
                    const snack = doc.data();
                    snackStock[snack.productId] = 0;
                });
                
                await db.collection('snackStock').doc(program).set({
                    ...snackStock,
                    program: program,
                    lastUpdated: new Date()
                });
                
                showMessage('‚úÖ Stock de tous les snacks r√©initialis√© √† 0', 'success');
                
                // Recharger l'affichage
                await loadSnacksStock();
                
                // Recharger les produits dans la page de commande
                loadProductsForOrders();
                
            } catch (error) {
                console.error('Erreur lors de la r√©initialisation:', error);
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Charger et afficher les produits dans la page de commande
        async function loadProductsForOrders() {
            try {
                // Charger les fillings
                let fillings = [];
                try {
                    const fillingsSnapshot = await db.collection('customFillings').orderBy('order', 'asc').get();
                    fillingsSnapshot.forEach(doc => {
                        fillings.push({ id: doc.id, ...doc.data() });
                    });
                } catch (error) {
                    // Si l'index n'existe pas, charger sans tri et trier en JavaScript
                    console.warn('Index manquant pour order, chargement sans tri:', error);
                    const fillingsSnapshot = await db.collection('customFillings').get();
                    fillingsSnapshot.forEach(doc => {
                        fillings.push({ id: doc.id, ...doc.data() });
                    });
                    fillings.sort((a, b) => (a.order || 999) - (b.order || 999));
                }
                
                // Charger les snacks
                let snacks = [];
                try {
                    const snacksSnapshot = await db.collection('customSnacks').orderBy('name', 'asc').get();
                    snacksSnapshot.forEach(doc => {
                        snacks.push({ id: doc.id, ...doc.data() });
                    });
                } catch (error) {
                    // Si l'index n'existe pas, charger sans tri et trier en JavaScript
                    console.warn('Index manquant pour name, chargement sans tri:', error);
                    const snacksSnapshot = await db.collection('customSnacks').get();
                    snacksSnapshot.forEach(doc => {
                        snacks.push({ id: doc.id, ...doc.data() });
                    });
                    snacks.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                }
                
                // Afficher les fillings (cr√™pes)
                const crepesGrid = document.getElementById('crepesGrid');
                if (crepesGrid) {
                    if (fillings.length === 0) {
                        crepesGrid.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #666; background: #f8f9fa; border-radius: 8px; grid-column: 1 / -1;">
                                Aucun filling configur√©. Les administrateurs peuvent en ajouter dans l'onglet "Personnalisation".
                            </div>
                        `;
                    } else {
                        crepesGrid.innerHTML = fillings.map(filling => `
                            <div class="product-card" onclick="selectProduct('${filling.productId}')">
                                <div class="product-icon">${filling.emoji || 'ü•û'}</div>
                                <div class="product-name">${filling.name}</div>
                                <div class="product-price">FREE</div>
                                <div class="product-description">${filling.description || '&nbsp;'}</div>
                                <button class="order-btn" onclick="showClassModal('${filling.productId}', 0)">Commander</button>
                            </div>
                        `).join('');
                    }
                }
                
                // Afficher les snacks (afficher tous les snacks, mais d√©sactiver si stock = 0)
                const snacksGrid = document.getElementById('snacksGrid');
                const snacksSection = document.getElementById('snacksSection');
                if (snacksGrid && snacksSection) {
                    if (snacks.length === 0) {
                        snacksSection.style.display = 'none';
                    } else {
                        // V√©rifier le stock des snacks
                        const program = getCurrentProgram();
                        console.log('Loading snacks for program:', program, 'Current user:', currentUser?.role, 'Current view:', currentView);
                        
                        const snackStockDoc = await db.collection('snackStock').doc(program).get();
                        const snackStock = snackStockDoc.exists ? snackStockDoc.data() : {};
                        console.log('Snack stock data:', snackStock);
                        
                        // Afficher tous les snacks, mais indiquer le stock et d√©sactiver si stock = 0
                        snacksSection.style.display = 'block';
                        snacksGrid.innerHTML = snacks.map(snack => {
                            const stock = snackStock[snack.productId] || 0;
                            const isAvailable = stock > 0;
                            const priceDisplay = (snack.price && snack.price > 0) ? `${snack.price}‚Ç¨` : 'FREE';
                            return `
                                <div class="product-card" style="${!isAvailable ? 'opacity: 0.6;' : ''}" onclick="${isAvailable ? `selectProduct('${snack.productId}')` : ''}">
                                    <div class="product-icon">${snack.emoji || 'üç™'}</div>
                                    <div class="product-name">${snack.name}</div>
                                    <div class="product-price">${priceDisplay}</div>
                                    <div class="product-description">${snack.description || '&nbsp;'}</div>
                                    <div style="font-size: 0.85rem; margin-bottom: 10px; ${isAvailable ? 'color: #28a745;' : 'color: #dc3545;'}">
                                        ${isAvailable ? `Stock: ${stock}` : 'Stock: 0 (Indisponible)'}
                                    </div>
                                    <button class="order-btn" ${!isAvailable ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} onclick="${isAvailable ? `showClassModal('${snack.productId}', ${snack.price || 0})` : 'return false;'}">
                                        ${isAvailable ? 'Commander' : 'Indisponible'}
                                    </button>
                                </div>
                            `;
                        }).join('');
                    }
                } else {
                    console.error('snacksGrid or snacksSection not found!', { snacksGrid, snacksSection });
                }
            } catch (error) {
                console.error('Erreur lors du chargement des produits:', error);
                const crepesGrid = document.getElementById('crepesGrid');
                if (crepesGrid) {
                    crepesGrid.innerHTML = `
                        <div class="error">Erreur lors du chargement des produits: ${error.message}</div>
                    `;
                }
            }
        }
        
    </script>
</body>
</html>
