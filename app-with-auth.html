<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connexion • Villa des Smaqers</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{--violet:#6c5ce7}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#6c5ce7,#a29bfe)}
    .card{background:#fff;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.18);padding:28px;width:92%;max-width:420px}
    h1{margin:0 0 6px 0;color:var(--violet)}
    p.muted{margin:0 0 16px 0;color:#666}
    .tabs{display:flex;gap:8px;margin:10px 0 20px}
    .tab{flex:1;padding:10px 12px;border-radius:10px;border:2px solid #eee;text-align:center;font-weight:700;color:#555;cursor:pointer}
    .tab.active{border-color:var(--violet);color:var(--violet);background:#f4f1ff}
    .group{margin-bottom:14px}
    label{display:block;margin:0 0 6px 2px;color:#333;font-weight:600}
    input,select{width:100%;padding:12px 12px;border:2px solid #e6e6e6;border-radius:10px;font-size:16px}
    input:focus,select:focus{outline:none;border-color:var(--violet)}
    .hint{font-size:12px;color:#888;margin-top:4px}
    .btn{width:100%;margin-top:10px;padding:12px 14px;border:none;border-radius:12px;background:var(--violet);color:#fff;font-weight:800;font-size:16px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>Villa des Smaqers</h1>
    <p class="muted">Connectez-vous ou créez un compte</p>

    <div class="tabs">
      <div class="tab active" id="tab-login">Connexion</div>
      <div class="tab" id="tab-register">Créer un compte</div>
    </div>

    <form id="form-login">
      <div class="group">
        <label for="login-email">Email</label>
        <input id="login-email" type="email" required autocomplete="email">
      </div>
      <div class="group">
        <label for="login-password">Mot de passe</label>
        <input id="login-password" type="password" required autocomplete="current-password">
      </div>
      <button class="btn" type="submit">Se connecter</button>
    </form>

    <form id="form-register" class="hidden">
      <div class="group">
        <label for="firstName">Prénom</label>
        <input id="firstName" required>
      </div>
      <div class="group">
        <label for="lastName">Nom</label>
        <input id="lastName" required>
      </div>
      <div class="group">
        <label for="email">Email</label>
        <input id="email" type="email" required autocomplete="email">
      </div>
      <div class="group">
        <label for="phone">Téléphone</label>
        <input id="phone" type="tel" required>
      </div>
      <div class="group">
        <label for="age">Âge</label>
        <input id="age" type="number" min="16" max="30" required>
      </div>
      <div class="group">
        <label for="password">Mot de passe</label>
        <input id="password" type="password" required autocomplete="new-password">
      </div>
      <div class="group">
        <label for="role">Rôle</label>
        <select id="role" required>
          <option value="">Choisir un rôle</option>
          <option value="student">Étudiant</option>
          <option value="member">Membre de la société</option>
        </select>
        <div class="hint">Le code n'est requis que pour les membres.</div>
      </div>
      <div class="group hidden" id="code-wrap">
        <label for="accessCode">Code d'accès (membre/admin)</label>
        <input id="accessCode" placeholder="ex: paco">
      </div>
      <button class="btn" type="submit">Créer le compte</button>
    </form>
  </div>

  <script>
    // Tabs toggle
    const tabLogin = document.getElementById('tab-login');
    const tabRegister = document.getElementById('tab-register');
    const formLogin = document.getElementById('form-login');
    const formRegister = document.getElementById('form-register');

    tabLogin.onclick = () => { tabLogin.classList.add('active'); tabRegister.classList.remove('active'); formLogin.classList.remove('hidden'); formRegister.classList.add('hidden'); };
    tabRegister.onclick = () => { tabRegister.classList.add('active'); tabLogin.classList.remove('active'); formRegister.classList.remove('hidden'); formLogin.classList.add('hidden'); };

    // Show/hide code for member
    const roleSelect = document.getElementById('role');
    const codeWrap = document.getElementById('code-wrap');
    roleSelect.addEventListener('change', () => {
      codeWrap.classList.toggle('hidden', roleSelect.value !== 'member');
    });

    // Minimal local auth store
    function saveAndGo(profile){
      try { localStorage.setItem('villa-smaqers-profile', JSON.stringify(profile)); } catch(e){}
      // ensure flags
      if (!profile.emailVerified) profile.emailVerified = true; // minimal flow for now
      // go to app
      window.location.href = 'app-with-roles.html';
    }

    // Login
    formLogin.addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if(!email || !password){ alert('Email et mot de passe requis'); return; }
      // Try existing profile from localStorage
      const raw = localStorage.getItem('villa-smaqers-profile');
      if(!raw){ alert('Aucun compte local trouvé. Créez un compte.'); tabRegister.click(); return; }
      const prof = JSON.parse(raw);
      if(prof.email !== email){ alert('Cet email n\'est pas enregistré sur cet appareil.'); return; }
      // Password check best-effort (not secure; real backend already prévu via Firebase)
      if(prof.password && prof.password !== password){ alert('Mot de passe incorrect'); return; }
      saveAndGo(prof);
    });

    // Register
    formRegister.addEventListener('submit', (e)=>{
      e.preventDefault();
      const profile = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        age: parseInt(document.getElementById('age').value, 10),
        password: document.getElementById('password').value,
        role: document.getElementById('role').value,
        accessCode: document.getElementById('accessCode').value.trim(),
        emailVerified: true,
        registrationDate: new Date().toISOString()
      };
      if(!profile.firstName||!profile.lastName||!profile.email||!profile.phone||!profile.age||!profile.password||!profile.role){
        alert('Veuillez remplir tous les champs'); return;
      }
      if(profile.role === 'member' && !profile.accessCode){ alert('Code requis pour les membres'); return; }
      // simple admin/member handling (matches app expectations: paco=admin, else member)
      if(profile.role === 'member'){
        if(profile.accessCode.toLowerCase() === 'paco'){ profile.role = 'admin'; }
        else { profile.role = 'member'; }
      }
      saveAndGo(profile);
    });

    // If already logged locally, skip to app
    try{
      const raw = localStorage.getItem('villa-smaqers-profile');
      if(raw){ const prof = JSON.parse(raw); if(prof && prof.email){ saveAndGo(prof); } }
    }catch(e){}
  </script>
</body>
</html>
